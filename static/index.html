<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>
  <div id="error" class="text-red-500 p-4"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");

      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);

      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split("T")[0],
        product: "",
        lot: "",
        quantity: "",
        expiryDate: "",
        company: "–ë–¢–¢"
      });
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split("T")[0],
        client: "",
        product: "",
        lot: "",
        quantity: "",
        manager: "",
        company: "–ë–¢–¢"
      });

      const [activeTab, setActiveTab] = useState("inventory");
      const [companies, setCompanies] = useState([]);
      const [company, setCompany] = useState("–ë–¢–¢");
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
      const [filterClient, setFilterClient] = useState("–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã");
      const [filterManager, setFilterManager] = useState("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã");
      const [startDate, setStartDate] = useState("");
      const [endDate, setEndDate] = useState("");
      const [error, setError] = useState("");
      const [editItem, setEditItem] = useState(null);
      const [loading, setLoading] = useState(false);
      const [collapsed, setCollapsed] = useState({}); // üëà –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø

      const saveTimeout = useRef(null);

      const admins = [
        { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
        { username: "–û–ª—å–≥–∞", password: "12345678oc" },
        { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
      ];

      const API_ORIGIN = window.location.origin;

      useEffect(() => {
        fetch(`${API_ORIGIN}/api/companies`)
          .then(r => r.json())
          .then(data => {
            setCompanies(data || ["–ë–¢–¢", "–õ–ò"]);
            if (data && data.length && !data.includes(company)) setCompany(data[0]);
          })
          .catch(e => setError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π: " + e.message));
      }, []);

      useEffect(() => {
        const loadData = (username, comp) => {
          setLoading(true);
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(username)}/${encodeURIComponent(comp)}`)
            .then(r => r.json())
            .then(data => {
              const inv = (data.inventory || []).map((it, i) => ({ ...it, company: it.company || comp, id: it.id || `inv_${Date.now()}_${i}` }));
              const shp = (data.shipments || []).map((it, i) => ({ ...it, company: it.company || comp, id: it.id || `ship_${Date.now()}_${i}` }));
              setInventory(inv);
              setShipments(shp);
              setProducts([...new Set([...inv.map(x => x.product), ...shp.map(x => x.product)])].filter(Boolean));
              setClients([...new Set(shp.map(x => x.client))].filter(Boolean));
              setManagers([...new Set(shp.map(x => x.manager))].filter(Boolean));
            })
            .catch(e => setError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + e.message))
            .finally(() => setLoading(false));
        };
        if (user) loadData(user, company);
        else loadData("–õ–µ–æ–Ω–∏–¥", company);
      }, [user, company]);

      useEffect(() => {
        if (loading || !user || userRole !== "admin") return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          }).catch(e => setError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message));
        }, 1000);
        return () => clearTimeout(saveTimeout.current);
      }, [inventory, shipments, user, userRole, company, loading]);

      const handleLogin = (e) => {
        e.preventDefault();
        const name = userName.trim();
        if (!name) { setError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); return; }
        const isAdmin = admins.find(a => a.username.toLowerCase() === name.toLowerCase() && a.password === password);
        if (password && !isAdmin) { setError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"); return; }
        setUser(name);
        setUserRole(isAdmin ? "admin" : "viewer");
        setPassword("");
        setError("");
      };

      const handleStockSubmit = (e) => {
        e.preventDefault();
        if (userRole !== "admin") { setError("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"); return; }
        try {
          if (editItem && editItem.id && !("client" in editItem)) {
            setInventory(inv => inv.map(i => i.id === editItem.id ? { ...i, ...newStock, quantity: Number(newStock.quantity), company } : i));
          } else {
            const existing = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
            if (existing) {
              setInventory(inv => inv.map(i => (i.product === newStock.product && i.lot === newStock.lot && i.company === company)
                ? { ...i, quantity: Number(i.quantity) + Number(newStock.quantity), expiryDate: newStock.expiryDate }
                : i));
            } else {
              const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
              setInventory(inv => [...inv, { ...newStock, id, quantity: Number(newStock.quantity), company }]);
            }
          }
          if (newStock.product && !products.includes(newStock.product)) setProducts(p => [...p, newStock.product]);
          setNewStock({ date: newStock.date, product: "", lot: "", quantity: "", expiryDate: "", company });
          setEditItem(null);
        } catch (e) { setError(e.message); }
      };

      const handleDeleteInventory = (item) => {
        if (userRole !== "admin") return;
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ ${item.product} –ª–æ—Ç ${item.lot}?`)) return;
        setInventory(inv => inv.filter(i => i.id !== item.id));
      };

      const handleEdit = (item) => {
        if (userRole !== "admin") return;
        setEditItem(item);
        setNewStock({ date: item.date, product: item.product, lot: item.lot, quantity: item.quantity, expiryDate: item.expiryDate || "", company: item.company || company });
        setActiveTab("inventory");
      };

      const groupedInventory = inventory.filter(i => i.company === company).reduce((acc, it) => {
        acc[it.product] = acc[it.product] || [];
        acc[it.product].push(it);
        return acc;
      }, {});

      const toggleGroup = (product) => {
        setCollapsed(prev => ({ ...prev, [product]: !prev[product] }));
      };

      if (!user) {
        return React.createElement('div', { className: 'max-w-md mx-auto p-4' },
          React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É'),
          React.createElement('form', { onSubmit: handleLogin, className: 'flex flex-col gap-2' },
            React.createElement('input', { placeholder: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', value: userName, onChange: e => setUserName(e.target.value), className: 'border p-2 rounded' }),
            React.createElement('input', { type: 'password', placeholder: '–ü–∞—Ä–æ–ª—å (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)', value: password, onChange: e => setPassword(e.target.value), className: 'border p-2 rounded' }),
            React.createElement('button', { type: 'submit', className: 'bg-blue-500 text-white py-2 px-4 rounded' }, '–í–æ–π—Ç–∏')
          )
        );
      }

      return React.createElement('div', { className: 'max-w-6xl mx-auto' },
        React.createElement('h1', { className: 'text-xl font-bold mb-4' }, `–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏: ${company}`),

        React.createElement('form', { onSubmit: handleStockSubmit, className: 'flex flex-wrap gap-2 mb-4' },
          React.createElement('input', { type: 'date', value: newStock.date, onChange: e => setNewStock(s => ({ ...s, date: e.target.value })), className: 'border p-2 rounded' }),
          React.createElement('input', { placeholder: '–ü—Ä–æ–¥—É–∫—Ü–∏—è', value: newStock.product, onChange: e => setNewStock(s => ({ ...s, product: e.target.value })), className: 'border p-2 rounded' }),
          React.createElement('input', { placeholder: '‚Ññ –õ–æ—Ç–∞', value: newStock.lot, onChange: e => setNewStock(s => ({ ...s, lot: e.target.value })), className: 'border p-2 rounded' }),
          React.createElement('input', { type: 'number', placeholder: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', value: newStock.quantity, onChange: e => setNewStock(s => ({ ...s, quantity: e.target.value })), className: 'border p-2 rounded' }),
          React.createElement('input', { type: 'date', placeholder: '–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏', value: newStock.expiryDate, onChange: e => setNewStock(s => ({ ...s, expiryDate: e.target.value })), className: 'border p-2 rounded' }),
          React.createElement('button', { type: 'submit', className: 'bg-green-500 text-white py-2 px-4 rounded' }, editItem ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å')
        ),

        Object.keys(groupedInventory).length === 0
          ? React.createElement('div', null, '–ù–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤')
          : Object.keys(groupedInventory).map((product, idx) => {
              const items = groupedInventory[product];
              const totalQty = items.reduce((s, i) => s + Number(i.quantity || 0), 0);
              const isCollapsed = collapsed[product];
              return React.createElement('div', { key: idx, className: 'mb-4 bg-white rounded shadow' },
                React.createElement('div', {
                  onClick: () => toggleGroup(product),
                  className: 'cursor-pointer bg-blue-100 p-3 font-semibold flex justify-between items-center'
                },
                  React.createElement('span', null, product || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
                  React.createElement('span', { className: 'text-sm text-gray-600' }, isCollapsed ? '‚ñ∂' : '‚ñº')
                ),
                !isCollapsed && React.createElement('div', { className: 'p-2' },
                  React.createElement('table', { className: 'w-full border-collapse' },
                    React.createElement('thead', null,
                      React.createElement('tr', { className: 'bg-gray-100' },
                        React.createElement('th', { className: 'border p-2' }, '–î–∞—Ç–∞'),
                        React.createElement('th', { className: 'border p-2' }, '‚Ññ –õ–æ—Ç–∞'),
                        React.createElement('th', { className: 'border p-2' }, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'),
                        React.createElement('th', { className: 'border p-2' }, '–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏'),
                        React.createElement('th', { className: 'border p-2' }, '–î–µ–π—Å—Ç–≤–∏—è')
                      )
                    ),
                    React.createElement('tbody', null,
                      items.map((item) => React.createElement('tr', { key: item.id },
                        React.createElement('td', { className: 'border p-2' }, item.date),
                        React.createElement('td', { className: 'border p-2' }, item.lot),
                        React.createElement('td', { className: 'border p-2' }, item.quantity),
                        React.createElement('td', { className: 'border p-2' }, item.expiryDate || ""),
                        React.createElement('td', { className: 'border p-2' },
                          React.createElement('button', { onClick: () => handleEdit(item), className: 'bg-yellow-500 text-white py-1 px-2 mr-2 rounded' }, '–†–µ–¥.'),
                          React.createElement('button', { onClick: () => handleDeleteInventory(item), className: 'bg-red-500 text-white py-1 px-2 rounded' }, '–£–¥–∞–ª.')
                        )
                      )),
                      React.createElement('tr', { className: 'bg-blue-50 font-semibold' },
                        React.createElement('td', { colSpan: 2, className: 'border p-2 text-right' }, '–ò—Ç–æ–≥–æ:'),
                        React.createElement('td', { className: 'border p-2' }, totalQty),
                        React.createElement('td', { colSpan: 2, className: 'border p-2' })
                      )
                    )
                  )
                )
              );
            })
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
