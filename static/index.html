<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>

  <script>
  (function() {
    const { useState, useEffect } = React;

    function App() {
      const [user, setUser] = useState(localStorage.getItem("wl_user") || null);
      const [userRole, setUserRole] = useState(localStorage.getItem("wl_role") || null);
      const [loginName, setLoginName] = useState("");
      const [loginPass, setLoginPass] = useState("");
      const [companies, setCompanies] = useState([]);
      const [company, setCompany] = useState(localStorage.getItem("wl_company") || "–ë–¢–¢");
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);

      const [filterFrom, setFilterFrom] = useState("");
      const [filterTo, setFilterTo] = useState("");
      const [filterShipProduct, setFilterShipProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
      const [filterClient, setFilterClient] = useState("–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã");
      const [filterManager, setFilterManager] = useState("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã");
      const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");

      const [newStock, setNewStock] = useState({ date: new Date().toISOString().split("T")[0], product: "", lot: "", quantity: "", expiryDate: "" });
      const [newShipment, setNewShipment] = useState({ date: new Date().toISOString().split("T")[0], client: "", product: "", lot: "", quantity: "", manager: "" });

      const [activeTab, setActiveTab] = useState("inventory");
      const API = window.location.origin;

      const admins = [
        { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
        { username: "–û–ª—å–≥–∞", password: "12345678oc" },
        { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
      ];

      const saveNow = async (inv = inventory, shp = shipments) => {
        if (!user) return;
        await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ inventory: inv, shipments: shp })
        }).catch(console.error);
      };

      const saveToOtherCompany = async (targetCompany, newInvData) => {
        try {
          const res = await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(targetCompany)}`);
          const data = await res.json();
          const targetInv = data.inventory || [];
          const existing = targetInv.find(i => i.product === newInvData.product && i.lot === newInvData.lot);
          if (existing) existing.quantity = Number(existing.quantity) + Number(newInvData.quantity);
          else targetInv.push({ ...newInvData, id: `inv_${Date.now()}`, company: targetCompany });
          await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(targetCompany)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory: targetInv, shipments: data.shipments || [] })
          });
          alert(`‚úî –ê–≤—Ç–æ–ø–µ—Ä–µ–Ω–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ ${targetCompany}`);
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–Ω–æ—Å–∞:", e);
        }
      };

      const handleLogin = (e) => {
        e.preventDefault();
        const admin = admins.find(a => a.username.toLowerCase() === loginName.toLowerCase() && a.password === loginPass);
        if (loginPass && !admin) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        const role = admin ? "admin" : "viewer";
        setUser(loginName); setUserRole(role);
        localStorage.setItem("wl_user", loginName); localStorage.setItem("wl_role", role);
      };

      const logout = () => { localStorage.clear(); setUser(null); setUserRole(null); };

      const productLots = (prod) => inventory.filter(i => i.product === prod && i.company === company).map(i => i.lot);

      useEffect(() => {
        fetch(`${API}/api/companies`).then(r => r.json()).then(d => setCompanies(d.length ? d : ["–ë–¢–¢", "–õ–ò"])).catch(() => setCompanies(["–ë–¢–¢", "–õ–ò"]));
      }, []);

      useEffect(() => {
        if (!user) return;
        fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
          .then(r => r.json())
          .then(data => {
            const inv = data.inventory || [];
            const shp = data.shipments || [];
            setInventory(inv); setShipments(shp);
            setProducts([...new Set(inv.map(x => x.product).filter(Boolean))]);
            setClients([...new Set(shp.map(x => x.client).filter(Boolean))]);
            setManagers([...new Set(shp.map(x => x.manager).filter(Boolean))]);
          });
      }, [user, company]);

      const handleStockSubmit = (e) => {
        e.preventDefault();
        const exist = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
        let newInv;
        if (exist) newInv = inventory.map(i => i.id === exist.id ? { ...i, quantity: +i.quantity + +newStock.quantity } : i);
        else newInv = [...inventory, { ...newStock, id: `inv_${Date.now()}`, company, quantity: +newStock.quantity }];
        setInventory(newInv); saveNow(newInv, shipments);
        setNewStock({ ...newStock, product: "", lot: "", quantity: "", expiryDate: "" });
      };

      const handleShipmentSubmit = async (e) => {
        e.preventDefault();
        const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
        if (!stock || stock.quantity < +newShipment.quantity) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏");
        const id = `ship_${Date.now()}`;
        const newShip = { ...newShipment, id, company, quantity: +newShipment.quantity };
        const newShips = [...shipments, newShip];
        const newInv = inventory.map(i => (i.product === newShipment.product && i.lot === newShipment.lot && i.company === company) ? { ...i, quantity: i.quantity - +newShipment.quantity } : i);
        setShipments(newShips); setInventory(newInv); saveNow(newInv, newShips);
        if ((company === "–ë–¢–¢" && newShipment.client === "–õ–ò") || (company === "–õ–ò" && newShipment.client === "–ë–¢–¢"))
          await saveToOtherCompany(company === "–ë–¢–¢" ? "–õ–ò" : "–ë–¢–¢", { date: newShipment.date, product: newShipment.product, lot: newShipment.lot, quantity: +newShipment.quantity });
        setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
      };

      const deleteShipment = (id) => { if (confirm("–£–¥–∞–ª–∏—Ç—å?")) { const s = shipments.filter(x => x.id !== id); setShipments(s); saveNow(inventory, s); } };
      const deleteInventory = (id) => { if (confirm("–£–¥–∞–ª–∏—Ç—å?")) { const i = inventory.filter(x => x.id !== id); setInventory(i); saveNow(i, shipments); } };

      const groupedInventory = inventory.filter(i => i.company === company && (filterProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || i.product === filterProduct))
        .reduce((acc, it) => { if (!acc[it.product]) acc[it.product] = []; acc[it.product].push(it); return acc; }, {});
      const filteredShipments = shipments
        .filter(s => s.company === company)
        .filter(s => !filterFrom || s.date >= filterFrom)
        .filter(s => !filterTo || s.date <= filterTo)
        .filter(s => filterShipProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || s.product === filterShipProduct)
        .filter(s => filterClient === "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" || s.client === filterClient)
        .filter(s => filterManager === "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" || s.manager === filterManager);

      if (!user)
        return React.createElement("form", { onSubmit: handleLogin, className: "max-w-md mx-auto mt-10 flex flex-col gap-2" },
          React.createElement("input", { placeholder: "–ò–º—è", value: loginName, onChange: e => setLoginName(e.target.value), className: "border p-2" }),
          React.createElement("input", { type: "password", placeholder: "–ü–∞—Ä–æ–ª—å", value: loginPass, onChange: e => setLoginPass(e.target.value), className: "border p-2" }),
          React.createElement("button", { type: "submit", className: "bg-blue-500 text-white p-2" }, "–í–æ–π—Ç–∏")
        );

      return (
        React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `–£—á–µ—Ç (${company}) ‚Äî ${user}`),
            React.createElement("div", null,
              React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 mr-2" },
                companies.map(c => React.createElement("option", { key: c }, c))),
              React.createElement("button", { onClick: logout, className: "bg-red-500 text-white px-3 py-2" }, "–í—ã–π—Ç–∏")
            )
          ),
          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Å—Ç–∞—Ç–∫–∏"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Ç–≥—Ä—É–∑–∫–∏")
          ),
          activeTab === "inventory" && React.createElement("div", null,
            React.createElement("div", { className: "flex gap-3 mb-4" },
              React.createElement("label", null, "–§–∏–ª—å—Ç—Ä:"),
              React.createElement("select", { value: filterProduct, onChange: e => setFilterProduct(e.target.value), className: "border p-2" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ"),
                products.map(p => React.createElement("option", { key: p, value: p }, p)))
            ),
            userRole === "admin" && React.createElement("form", { onSubmit: handleStockSubmit, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newStock.date, onChange: e => setNewStock(s => ({ ...s, date: e.target.value })), className: "border p-2" }),
              React.createElement("input", { list: "prodList", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è", value: newStock.product, onChange: e => setNewStock(s => ({ ...s, product: e.target.value })), className: "border p-2" }),
              React.createElement("datalist", { id: "prodList" }, products.map(p => React.createElement("option", { key: p, value: p }))),
              React.createElement("input", { list: "lotList", placeholder: "–õ–æ—Ç", value: newStock.lot, onChange: e => setNewStock(s => ({ ...s, lot: e.target.value })), className: "border p-2" }),
              React.createElement("datalist", { id: "lotList" }, inventory.filter(i => i.product === newStock.product).map((i, n) => React.createElement("option", { key: n, value: i.lot }))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª-–≤–æ", value: newStock.quantity, onChange: e => setNewStock(s => ({ ...s, quantity: e.target.value })), className: "border p-2" }),
              React.createElement("input", { type: "date", placeholder: "–°—Ä–æ–∫", value: newStock.expiryDate, onChange: e => setNewStock(s => ({ ...s, expiryDate: e.target.value })), className: "border p-2" }),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white px-4" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),
            Object.entries(groupedInventory).map(([p, items]) =>
              React.createElement("div", { key: p, className: "mb-6" },
                React.createElement("h2", { className: "font-bold mb-1" }, p),
                React.createElement("table", { className: "w-full border" },
                  React.createElement("tbody", null,
                    items.map(it => React.createElement("tr", { key: it.id },
                      React.createElement("td", { className: "border p-1" }, it.date),
                      React.createElement("td", { className: "border p-1" }, it.lot),
                      React.createElement("td", { className: "border p-1" }, it.quantity),
                      React.createElement("td", { className: "border p-1" }, it.expiryDate),
                      React.createElement("td", { className: "border p-1" }, userRole === "admin" && React.createElement("button", { onClick: () => deleteInventory(it.id), className: "text-red-500" }, "üóëÔ∏è"))
                    )),
                    React.createElement("tr", { className: "font-bold bg-gray-50" },
                      React.createElement("td", { colSpan: 2, className: "border p-1" }, "–ò—Ç–æ–≥–æ"),
                      React.createElement("td", { className: "border p-1" }, items.reduce((a,b)=>a+Number(b.quantity),0)),
                      React.createElement("td", { colSpan: 2, className: "border p-1" })
                    )
                  )
                )
              )
            )
          ),
          activeTab === "shipments" && React.createElement("div", null,
            React.createElement("div", { className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: filterFrom, onChange: e => setFilterFrom(e.target.value), className: "border p-2" }),
              React.createElement("input", { type: "date", value: filterTo, onChange: e => setFilterTo(e.target.value), className: "border p-2" }),
              React.createElement("select", { value: filterShipProduct, onChange: e => setFilterShipProduct(e.target.value), className: "border p-2" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))),
              React.createElement("select", { value: filterClient, onChange: e => setFilterClient(e.target.value), className: "border p-2" },
                React.createElement("option", { value: "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" }, "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"),
                clients.map(c => React.createElement("option", { key: c, value: c }, c))),
              React.createElement("select", { value: filterManager, onChange: e => setFilterManager(e.target.value), className: "border p-2" },
                React.createElement("option", { value: "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" }, "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã"),
                managers.map(m => React.createElement("option", { key: m, value: m }, m)))
            ),
            userRole === "admin" && React.createElement("form", { onSubmit: handleShipmentSubmit, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newShipment.date, onChange: e => setNewShipment(s => ({ ...s, date: e.target.value })), className: "border p-2" }),
              React.createElement("input", { list: "clientList", placeholder: "–ö–ª–∏–µ–Ω—Ç", value: newShipment.client, onChange: e => setNewShipment(s => ({ ...s, client: e.target.value })), className: "border p-2" }),
              React.createElement("datalist", { id: "clientList" }, clients.map(c => React.createElement("option", { key: c, value: c }))),
              React.createElement("input", { list: "prodListShip", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è", value: newShipment.product, onChange: e => setNewShipment(s => ({ ...s, product: e.target.value, lot: "" })), className: "border p-2" }),
              React.createElement("datalist", { id: "prodListShip" }, products.map(p => React.createElement("option", { key: p, value: p }))),
              React.createElement("input", { list: "lotListShip", placeholder: "–õ–æ—Ç", value: newShipment.lot, onChange: e => setNewShipment(s => ({ ...s, lot: e.target.value })), className: "border p-2" }),
              React.createElement("datalist", { id: "lotListShip" }, productLots(newShipment.product).map((l,i)=>React.createElement("option",{key:i,value:l}))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª-–≤–æ", value: newShipment.quantity, onChange: e => setNewShipment(s => ({ ...s, quantity: e.target.value })), className: "border p-2" }),
              React.createElement("input", { list: "managerList", placeholder: "–ú–µ–Ω–µ–¥–∂–µ—Ä", value: newShipment.manager, onChange: e => setNewShipment(s => ({ ...s, manager: e.target.value })), className: "border p-2" }),
              React.createElement("datalist", { id: "managerList" }, managers.map(m => React.createElement("option", { key: m, value: m }))),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white px-4" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),
            filteredShipments.map(s => React.createElement("div", { key: s.id, className: "bg-white rounded shadow p-3 mb-2 flex justify-between" },
              React.createElement("div", null, `${s.date} ‚Äî ${s.client} ‚Äî ${s.product} (${s.lot})`),
              React.createElement("div", null, `${s.quantity} —à—Ç. ‚Äî ${s.manager}`, userRole === "admin" && React.createElement("button", { onClick: () => deleteShipment(s.id), className: "text-red-500 ml-2" }, "üóëÔ∏è"))
            ))
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  })();
  </script>
</body>
</html>
