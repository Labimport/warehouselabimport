<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-50">
  <div id="root" class="p-4"></div>
  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split("T")[0],
        product: "",
        lot: "",
        quantity: "",
        expiryDate: "",
        company: "–ë–¢–¢"
      });
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split("T")[0],
        client: "",
        product: "",
        lot: "",
        quantity: "",
        manager: "",
        company: "–ë–¢–¢"
      });
      const [activeTab, setActiveTab] = useState("inventory");
      const [companies, setCompanies] = useState([]);
      const [company, setCompany] = useState("–ë–¢–¢");
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");

      // üîπ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç–≥—Ä—É–∑–æ–∫
      const [filterDateFrom, setFilterDateFrom] = useState("");
      const [filterDateTo, setFilterDateTo] = useState("");
      const [filterShipProduct, setFilterShipProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
      const [filterClient, setFilterClient] = useState("–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã");
      const [filterManager, setFilterManager] = useState("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã");

      const saveTimeout = useRef(null);
      const API_ORIGIN = window.location.origin;

      const admins = [
        { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
        { username: "–û–ª—å–≥–∞", password: "12345678oc" },
        { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
      ];

      // === –ê–≤—Ç–æ–≤—Ö–æ–¥ ===
      useEffect(() => {
        const savedUser = localStorage.getItem("user");
        const savedPass = localStorage.getItem("pass");
        if (savedUser) {
          const admin = admins.find(a => a.username === savedUser && a.password === savedPass);
          setUser(savedUser);
          setUserRole(admin ? "admin" : "viewer");
          setUserName(savedUser);
          setPassword(savedPass || "");
        }
      }, []);

      // === –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π ===
      useEffect(() => {
        fetch(`${API_ORIGIN}/api/companies`)
          .then(r => r.json())
          .then(d => setCompanies(d || ["–ë–¢–¢", "–õ–ò"]))
          .catch(() => setCompanies(["–ë–¢–¢", "–õ–ò"]));
      }, []);

      // === –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–ø–∞–Ω–∏–∏ ===
      useEffect(() => {
        if (!user) return;
        setInventory([]);
        setShipments([]);
        fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
          .then(r => r.json())
          .then(data => {
            const inv = (data.inventory || []).map((it, i) => ({ ...it, id: it.id || `inv_${Date.now()}_${i}` }));
            const shp = (data.shipments || []).map((it, i) => ({ ...it, id: it.id || `ship_${Date.now()}_${i}` }));
            setInventory(inv);
            setShipments(shp);
            setProducts([...new Set(inv.map(x => x.product).filter(Boolean))]);
            setClients([...new Set(shp.map(x => x.client).filter(Boolean))]);
            setManagers([...new Set(shp.map(x => x.manager).filter(Boolean))]);
          })
          .catch(console.error);
      }, [user, company]);

      // === –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===
      useEffect(() => {
        if (!user || userRole !== "admin") return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          }).catch(console.error);
        }, 800);
        return () => clearTimeout(saveTimeout.current);
      }, [inventory, shipments, company]);

      // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
      const handleLogin = (e) => {
        e.preventDefault();
        const admin = admins.find(a => a.username.toLowerCase() === userName.toLowerCase() && a.password === password);
        if (password && !admin) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        setUser(userName);
        setUserRole(admin ? "admin" : "viewer");
        localStorage.setItem("user", userName);
        localStorage.setItem("pass", password);
      };

      // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ ===
      const handleStockSubmit = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return;
        const existing = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
        if (existing) {
          setInventory(inv => inv.map(i => i.id === existing.id ? { ...i, quantity: Number(i.quantity) + Number(newStock.quantity) } : i));
        } else {
          const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`;
          setInventory(inv => [...inv, { ...newStock, id, quantity: Number(newStock.quantity), company }]);
        }
        setNewStock({ ...newStock, product: "", lot: "", quantity: "", expiryDate: "" });
      };

      // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏ ===
      const handleShipmentSubmit = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return;
        const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
        if (!stock || stock.quantity < Number(newShipment.quantity)) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ!");
        const id = `ship_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`;
        setShipments(s => [...s, { ...newShipment, id, quantity: Number(newShipment.quantity), company }]);
        setInventory(inv => inv.map(i =>
          i.product === newShipment.product && i.lot === newShipment.lot && i.company === company
            ? { ...i, quantity: i.quantity - newShipment.quantity }
            : i
        ));
        setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
      };

      // === –≠–∫—Å–ø–æ—Ä—Ç ===
      const exportInventory = () => {
        const data = inventory.filter(i => i.company === company).map(i => ({
          –î–∞—Ç–∞: i.date, –ü—Ä–æ–¥—É–∫—Ü–∏—è: i.product, –õ–æ—Ç: i.lot, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: i.quantity, "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏": i.expiryDate
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "–û—Å—Ç–∞—Ç–∫–∏");
        saveAs(new Blob([XLSX.write(wb, { bookType: "xlsx", type: "array" })]), `–û—Å—Ç–∞—Ç–∫–∏_${company}.xlsx`);
      };

      const exportShipments = () => {
        const data = shipments.filter(s => s.company === company).map(s => ({
          –î–∞—Ç–∞: s.date, –ö–ª–∏–µ–Ω—Ç: s.client, –ü—Ä–æ–¥—É–∫—Ü–∏—è: s.product, –õ–æ—Ç: s.lot, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: s.quantity, –ú–µ–Ω–µ–¥–∂–µ—Ä: s.manager
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "–û—Ç–≥—Ä—É–∑–∫–∏");
        saveAs(new Blob([XLSX.write(wb, { bookType: "xlsx", type: "array" })]), `–û—Ç–≥—Ä—É–∑–∫–∏_${company}.xlsx`);
      };

      // === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ===
      const groupedInventory = inventory
        .filter(i => i.company === company && (filterProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || i.product === filterProduct))
        .reduce((acc, i) => {
          if (!acc[i.product]) acc[i.product] = [];
          acc[i.product].push(i);
          return acc;
        }, {});

      const filteredShipments = shipments
        .filter(s => s.company === company)
        .filter(s =>
          (!filterDateFrom || s.date >= filterDateFrom) &&
          (!filterDateTo || s.date <= filterDateTo) &&
          (filterShipProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || s.product === filterShipProduct) &&
          (filterClient === "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" || s.client === filterClient) &&
          (filterManager === "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" || s.manager === filterManager)
        );

      // === –£–¥–∞–ª–µ–Ω–∏–µ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ===
      const deleteInventory = (id) => confirm("–£–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫?") && setInventory(prev => prev.filter(i => i.id !== id));
      const deleteShipment = (id) => confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É?") && setShipments(prev => prev.filter(s => s.id !== id));

      if (!user) return (
        React.createElement("div", { className: "max-w-md mx-auto p-4" },
          React.createElement("h1", { className: "text-2xl font-bold mb-4" }, "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É"),
          React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
            React.createElement("input", { placeholder: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", value: userName, onChange: e => setUserName(e.target.value), className: "border p-2 rounded" }),
            React.createElement("input", { type: "password", placeholder: "–ü–∞—Ä–æ–ª—å (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)", value: password, onChange: e => setPassword(e.target.value), className: "border p-2 rounded" }),
            React.createElement("button", { type: "submit", className: "bg-blue-500 text-white py-2 px-4 rounded" }, "–í–æ–π—Ç–∏")
          )
        )
      );

      return (
        React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (${company}) ‚Äî ${user}`),
            React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 rounded" },
              companies.map(c => React.createElement("option", { key: c }, c))
            )
          ),

          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Å—Ç–∞—Ç–∫–∏"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Ç–≥—Ä—É–∑–∫–∏")
          ),

          // === –û—Å—Ç–∞—Ç–∫–∏ ===
          activeTab === "inventory" && React.createElement("div", null,
            React.createElement("div", { className: "flex items-center gap-3 mb-4" },
              React.createElement("label", null, "–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏:"),
              React.createElement("select", { value: filterProduct, onChange: e => setFilterProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))
              ),
              React.createElement("button", { onClick: exportInventory, className: "bg-green-600 text-white px-4 py-2 rounded ml-auto" }, "‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç")
            ),
            Object.entries(groupedInventory).map(([product, items]) =>
              React.createElement("div", { key: product, className: "mb-6" },
                React.createElement("h2", { className: "text-lg font-semibold mb-2" }, product),
                React.createElement("table", { className: "w-full border-collapse bg-white shadow" },
                  React.createElement("thead", null,
                    React.createElement("tr", { className: "bg-gray-100" },
                      ["–î–∞—Ç–∞", "–õ–æ—Ç", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏", "–î–µ–π—Å—Ç–≤–∏—è"].map(h =>
                        React.createElement("th", { key: h, className: "border p-2 text-left" }, h)
                      )
                    )
                  ),
                  React.createElement("tbody", null,
                    items.map(it =>
                      React.createElement("tr", { key: it.id },
                        React.createElement("td", { className: "border p-2" }, it.date),
                        React.createElement("td", { className: "border p-2" }, it.lot),
                        React.createElement("td", { className: "border p-2" }, it.quantity),
                        React.createElement("td", { className: "border p-2" }, it.expiryDate),
                        React.createElement("td", { className: "border p-2" },
                          userRole === "admin"
                            ? React.createElement("span", null,
                                React.createElement("button", { onClick: () => deleteInventory(it.id), className: "text-red-500" }, "üóëÔ∏è")
                              )
                            : "-"
                        )
                      )
                    ),
                    React.createElement("tr", { className: "font-bold bg-gray-50" },
                      React.createElement("td", { className: "border p-2", colSpan: 2 }, "–ò—Ç–æ–≥–æ –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏"),
                      React.createElement("td", { className: "border p-2" },
                        items.reduce((sum, i) => sum + Number(i.quantity || 0), 0)
                      ),
                      React.createElement("td", { className: "border p-2", colSpan: 2 })
                    )
                  )
                )
              )
            )
          ),

          // === –û—Ç–≥—Ä—É–∑–∫–∏ ===
          activeTab === "shipments" && React.createElement("div", null,
            React.createElement("div", { className: "flex flex-wrap gap-2 mb-4 items-end" },
              React.createElement("div", null,
                React.createElement("label", null, "–û—Ç –¥–∞—Ç—ã:"),
                React.createElement("input", { type: "date", value: filterDateFrom, onChange: e => setFilterDateFrom(e.target.value), className: "border p-2 rounded ml-2" })
              ),
              React.createElement("div", null,
                React.createElement("label", null, "–î–æ –¥–∞—Ç—ã:"),
                React.createElement("input", { type: "date", value: filterDateTo, onChange: e => setFilterDateTo(e.target.value), className: "border p-2 rounded ml-2" })
              ),
              React.createElement("select", { value: filterShipProduct, onChange: e => setFilterShipProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))
              ),
              React.createElement("select", { value: filterClient, onChange: e => setFilterClient(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" }, "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"),
                clients.map(c => React.createElement("option", { key: c, value: c }, c))
              ),
              React.createElement("select", { value: filterManager, onChange: e => setFilterManager(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" }, "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã"),
                managers.map(m => React.createElement("option", { key: m, value: m }, m))
              ),
              React.createElement("button", { onClick: exportShipments, className: "bg-green-600 text-white px-4 py-2 rounded ml-auto" }, "‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç")
            ),

            filteredShipments.map(s =>
              React.createElement("div", { key: s.id, className: "bg-white rounded shadow p-3 mb-2 flex justify-between" },
                React.createElement("div", null, `${s.date} ‚Äî ${s.client} ‚Äî ${s.product} (${s.lot})`),
                React.createElement("div", null, `${s.quantity} —à—Ç. ‚Äî ${s.manager}`,
                  userRole === "admin" && React.createElement("button", { onClick: () => deleteShipment(s.id), className: "text-red-500 ml-2" }, "üóëÔ∏è")
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
