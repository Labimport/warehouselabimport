<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Учет продукции на складе</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>
  <div id="error" class="text-red-500 p-4"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      // user/auth
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");

      // data
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);

      // forms
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split("T")[0],
        product: "",
        lot: "",
        quantity: "",
        expiryDate: "",
        company: "БТТ"
      });
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split("T")[0],
        client: "",
        product: "",
        lot: "",
        quantity: "",
        manager: "",
        company: "БТТ"
      });

      // UI state
      const [activeTab, setActiveTab] = useState("inventory");
      const [companies, setCompanies] = useState([]);
      const [company, setCompany] = useState("БТТ");
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [filterProduct, setFilterProduct] = useState("Все продукты");
      const [filterClient, setFilterClient] = useState("Все клиенты");
      const [filterManager, setFilterManager] = useState("Все менеджеры");
      const [startDate, setStartDate] = useState("");
      const [endDate, setEndDate] = useState("");
      const [error, setError] = useState("");
      const [editItem, setEditItem] = useState(null);
      const [loading, setLoading] = useState(false);
      const saveTimeout = useRef(null);

      const admins = [
        { username: "Леонид", password: "12345678lm" },
        { username: "Ольга", password: "12345678oc" },
        { username: "Дмитрий", password: "12345678dd" }
      ];

      const API_ORIGIN = window.location.origin;

      // load companies
      useEffect(() => {
        fetch(`${API_ORIGIN}/api/companies`)
          .then(r => r.json())
          .then(data => {
            setCompanies(data || ["БТТ", "ЛИ"]);
            if (data && data.length && !data.includes(company)) setCompany(data[0]);
          })
          .catch(e => setError("Ошибка загрузки компаний: " + e.message));
      }, []);

      // load data
      useEffect(() => {
        const loadData = (username, comp) => {
          setLoading(true);
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(username)}/${encodeURIComponent(comp)}`)
            .then(r => r.json())
            .then(data => {
              const inv = (data.inventory || []).map((i, idx) => ({ ...i, company: comp, id: i.id || `inv_${Date.now()}_${idx}` }));
              const shp = (data.shipments || []).map((i, idx) => ({ ...i, company: comp, id: i.id || `ship_${Date.now()}_${idx}` }));
              setInventory(inv);
              setShipments(shp);
              const allProducts = [...new Set([...inv.map(x => x.product), ...shp.map(x => x.product)])];
              setProducts(allProducts.filter(Boolean));
              setClients([...new Set(shp.map(s => s.client))].filter(Boolean));
              setManagers([...new Set(shp.map(s => s.manager))].filter(Boolean));
            })
            .catch(e => setError("Ошибка загрузки данных: " + e.message))
            .finally(() => setLoading(false));
        };
        if (user) loadData(user, company); else loadData("Леонид", company);
      }, [user, company]);

      // autosave
      useEffect(() => {
        if (loading || !user || userRole !== "admin") return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          }).catch(e => setError("Ошибка сохранения: " + e.message));
        }, 1000);
      }, [inventory, shipments, user, userRole, company, loading]);

      // login
      const handleLogin = (e) => {
        e.preventDefault();
        const name = userName.trim();
        const isAdmin = admins.find(a => a.username.toLowerCase() === name.toLowerCase() && a.password === password);
        if (password && !isAdmin) { setError("Неверный пароль"); return; }
        setUser(name);
        setUserRole(isAdmin ? "admin" : "viewer");
      };

      // edit helpers
      const handleEdit = (item) => {
        if (userRole !== "admin") return setError("Нет прав на редактирование");
        setEditItem(item);
        if (item.client !== undefined) {
          setNewShipment(item);
          setActiveTab("shipments");
        } else {
          setNewStock(item);
          setActiveTab("inventory");
        }
      };

      // delete helpers
      const handleDeleteInventory = (item) => {
        if (userRole !== "admin") return setError("Нет прав на удаление");
        if (confirm(`Удалить остаток ${item.product} ${item.lot}?`))
          setInventory(inv => inv.filter(i => i.id !== item.id));
      };
      const handleDeleteShipment = (item) => {
        if (userRole !== "admin") return setError("Нет прав на удаление");
        if (confirm(`Удалить отгрузку ${item.product} ${item.lot}?`)) {
          setShipments(s => s.filter(i => i.id !== item.id));
          setInventory(inv => inv.map(i =>
            i.product === item.product && i.lot === item.lot && i.company === company
              ? { ...i, quantity: Number(i.quantity) + Number(item.quantity) }
              : i));
        }
      };

      // add stock
      const handleStockSubmit = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return setError("Нет прав на добавление");
        if (editItem) {
          setInventory(inv => inv.map(i => i.id === editItem.id ? newStock : i));
          setEditItem(null);
        } else {
          const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
          setInventory(inv => [...inv, { ...newStock, id, quantity: Number(newStock.quantity), company }]);
        }
        setNewStock({ ...newStock, product: "", lot: "", quantity: "" });
      };

      // add shipment
      const handleShipmentSubmit = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return setError("Нет прав на добавление");
        const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
        if (!stock || stock.quantity < Number(newShipment.quantity)) return setError("Недостаточно на складе");
        if (editItem) {
          setShipments(s => s.map(i => i.id === editItem.id ? newShipment : i));
          setEditItem(null);
        } else {
          const id = `ship_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
          setShipments(s => [...s, { ...newShipment, id, quantity: Number(newShipment.quantity), company }]);
          setInventory(inv => inv.map(i => i.product === newShipment.product && i.lot === newShipment.lot ? { ...i, quantity: Number(i.quantity) - Number(newShipment.quantity) } : i));
        }
        setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
      };

      // grouping
      const groupedInventory = inventory.filter(i => i.company === company)
        .reduce((acc, it) => {
          acc[it.product] = acc[it.product] || [];
          acc[it.product].push(it);
          return acc;
        }, {});

      // --- RENDER ---
      if (!user)
        return (
          React.createElement("div", { className: "max-w-md mx-auto p-4" },
            React.createElement("h1", { className: "text-2xl font-bold mb-2" }, "Вход"),
            React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
              React.createElement("input", { placeholder: "Имя", value: userName, onChange: e => setUserName(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "password", placeholder: "Пароль", value: password, onChange: e => setPassword(e.target.value), className: "border p-2 rounded" }),
              React.createElement("button", { type: "submit", className: "bg-blue-500 text-white py-2 rounded" }, "Войти")
            ),
            error && React.createElement("div", { className: "text-red-500 mt-2" }, error)
          )
        );

      return (
        React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between items-center mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `Учет продукции — ${company} (${userRole})`),
            React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 rounded" },
              companies.map(c => React.createElement("option", { key: c }, c))
            )
          ),
          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "Остатки"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "Отгрузки")
          ),
          error && React.createElement("div", { className: "text-red-500 mb-2" }, error),

          // ===== INVENTORY =====
          activeTab === "inventory" && React.createElement("div", null,
            Object.keys(groupedInventory).map(prod => {
              const items = groupedInventory[prod];
              const totalQty = items.reduce((s, i) => s + Number(i.quantity || 0), 0);
              return React.createElement("div", { key: prod, className: "bg-white p-3 rounded shadow mb-4" },
                React.createElement("h3", { className: "font-semibold" }, prod),
                React.createElement("table", { className: "w-full mt-2 border-collapse" },
                  React.createElement("thead", null,
                    React.createElement("tr", { className: "bg-gray-100" },
                      ["Дата", "№ Лота", "Количество", "Срок годности", "Действия"].map(h => React.createElement("th", { key: h, className: "border p-2" }, h))
                    )
                  ),
                  React.createElement("tbody", null,
                    items.map(i => React.createElement("tr", { key: i.id },
                      React.createElement("td", { className: "border p-2" }, i.date),
                      React.createElement("td", { className: "border p-2" }, i.lot),
                      React.createElement("td", { className: "border p-2" }, i.quantity),
                      React.createElement("td", { className: "border p-2" }, i.expiryDate || ""),
                      React.createElement("td", { className: "border p-2" },
                        React.createElement("button", { onClick: () => handleEdit(i), className: "bg-yellow-500 text-white py-1 px-2 mr-2 rounded" }, "Ред."),
                        React.createElement("button", { onClick: () => handleDeleteInventory(i), className: "bg-red-500 text-white py-1 px-2 rounded" }, "Удал.")
                      )
                    )),
                    // Итог
                    React.createElement("tr", { className: "bg-blue-50 font-semibold" },
                      React.createElement("td", { colSpan: 2, className: "border p-2 text-right" }, "Итого:"),
                      React.createElement("td", { className: "border p-2" }, totalQty),
                      React.createElement("td", { colSpan: 2, className: "border p-2" })
                    )
                  )
                )
              );
            })
          ),

          // ===== SHIPMENTS =====
          activeTab === "shipments" && React.createElement("div", null,
            React.createElement("div", { className: "bg-white rounded shadow overflow-auto" },
              React.createElement("table", { className: "w-full" },
                React.createElement("thead", null,
                  React.createElement("tr", { className: "bg-gray-100" },
                    ["Дата", "Клиент", "Продукция", "№ Лота", "Количество", "Менеджер", "Действия"].map(h => React.createElement("th", { key: h, className: "border p-2" }, h))
                  )
                ),
                React.createElement("tbody", null,
                  shipments
                    .filter(s => s.company === company)
                    .map(s => React.createElement("tr", { key: s.id },
                      React.createElement("td", { className: "border p-2" }, s.date),
                      React.createElement("td", { className: "border p-2" }, s.client),
                      React.createElement("td", { className: "border p-2" }, s.product),
                      React.createElement("td", { className: "border p-2" }, s.lot),
                      React.createElement("td", { className: "border p-2" }, s.quantity),
                      React.createElement("td", { className: "border p-2" }, s.manager),
                      React.createElement("td", { className: "border p-2" },
                        React.createElement("button", { onClick: () => handleEdit(s), className: "bg-yellow-500 text-white py-1 px-2 mr-2 rounded" }, "Ред."),
                        React.createElement("button", { onClick: () => handleDeleteShipment(s), className: "bg-red-500 text-white py-1 px-2 rounded" }, "Удал.")
                      )
                    )),
                  // Общий итог
                  React.createElement("tr", { className: "bg-blue-50 font-semibold" },
                    React.createElement("td", { colSpan: 4, className: "border p-2 text-right" }, "Итого отгружено:"),
                    React.createElement("td", { className: "border p-2" },
                      shipments.filter(s => s.company === company)
                        .reduce((sum, s) => sum + Number(s.quantity || 0), 0)
                    ),
                    React.createElement("td", { colSpan: 2, className: "border p-2" })
                  )
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
