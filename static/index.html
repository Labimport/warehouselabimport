<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учет продукции на складе</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <div id="error" class="text-red-500 p-4"></div>
  <script>
    const { useState, useEffect } = React;

    const App = () => {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState('');
      const [password, setPassword] = useState('');
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        client: '',
        quantity: '',
        manager: ''
      });
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        quantity: '',
        expiryDate: ''
      });
      const [groupBy, setGroupBy] = useState('week');
      const [activeTab, setActiveTab] = useState('inventory');
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [error, setError] = useState('');
      const [filterProduct, setFilterProduct] = useState('Все продукты');
      const [editItem, setEditItem] = useState(null);
      const [company, setCompany] = useState('БТТ');
      const [companies, setCompanies] = useState([]);

      const admins = [
        { username: 'Леонид', password: '12345678lm' },
        { username: 'Ольга', password: '12345678oc' },
        { username: 'Дмитрий', password: '12345678dd' }
      ];

      useEffect(() => {
        fetch('/api/companies')
          .then(response => response.json())
          .then(data => setCompanies(data || ['БТТ', 'ЛИ']));
      }, []);

      useEffect(() => {
        const loadData = (username, company) => {
          fetch(`/api/data/${username}/${company}`)
            .then(response => response.json())
            .then(data => {
              console.log('Полученные данные:', data);
              setInventory(data.inventory.map((item, index) => ({ ...item, id: item.id || `inv_${Date.now()}_${index}` })) || []);
              setShipments(data.shipments.map((item, index) => ({ ...item, id: item.id || `ship_${Date.now()}_${index}` })) || []);
              const allProducts = [...new Set([...data.inventory.map(i => i.product), ...data.shipments.map(s => s.product)])];
              const allClients = [...new Set(data.shipments.map(s => s.client))];
              const allManagers = [...new Set(data.shipments.map(s => s.manager))];
              setProducts(allProducts.filter(p => p));
              setClients(allClients.filter(c => c));
              setManagers(allManagers.filter(m => m));
            })
            .catch(error => setError('Ошибка загрузки данных: ' + error.message));
        };

        if (user) {
          loadData(user, company);
        } else {
          loadData('Леонид', company); // Для неавторизованных пользователей показываем данные от 'Леонид' для выбранной компании
        }
      }, [user, company]);

      useEffect(() => {
        if (user && userRole === 'admin') {
          saveData(user, company, { inventory, shipments });
        }
      }, [inventory, shipments, user, company]);

      const saveData = (username, company, data) => {
        console.log('Отправка данных на сервер:', data);
        fetch(`/api/data/${username}/${company}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .catch(error => setError('Ошибка сохранения данных: ' + error.message));
      };

      const handleLogin = (e) => {
        e.preventDefault();
        if (!userName.trim()) {
          setError('Введите имя пользователя');
          return;
        }
        const trimmedUserName = userName.trim();
        console.log('Проверка входа:', { username: trimmedUserName, password });
        const isAdmin = admins.find(
          (admin) => admin.username.toLowerCase() === trimmedUserName.toLowerCase() && admin.password === password
        );
        if (password && !isAdmin) {
          setError('Неверный пароль для администратора');
          return;
        }
        setUser(trimmedUserName);
        const newRole = isAdmin ? 'admin' : 'viewer';
        setUserRole(newRole);
        setPassword('');
      };

      const handleStockSubmit = (e) => {
        e.preventDefault();
        if (userRole !== 'admin') {
          setError('Только администраторы могут добавлять остатки');
          return;
        }
        try {
          if (editItem) {
            setInventory(
              inventory.map((item) =>
                item.id === editItem.id
                  ? { ...newStock, quantity: Number(newStock.quantity), id: editItem.id }
                  : item
              )
            );
          } else {
            const existing = inventory.find(
              (item) => item.product === newStock.product && item.lot === newStock.lot
            );
            if (existing) {
              setInventory(
                inventory.map((item) =>
                  item.product === newStock.product && item.lot === newStock.lot
                    ? { ...item