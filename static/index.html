<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-50">
  <div id="root" class="p-4"></div>
  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split("T")[0],
        product: "",
        lot: "",
        quantity: "",
        expiryDate: "",
        company: "–ë–¢–¢"
      });
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split("T")[0],
        client: "",
        product: "",
        lot: "",
        quantity: "",
        manager: "",
        company: "–ë–¢–¢"
      });
      const [activeTab, setActiveTab] = useState("inventory");
      const [companies, setCompanies] = useState([]);
      const [company, setCompany] = useState("–ë–¢–¢");
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
      const [loading, setLoading] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const [editType, setEditType] = useState(null);

      const saveTimeout = useRef(null);
      const API_ORIGIN = window.location.origin;

      const admins = [
        { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
        { username: "–û–ª—å–≥–∞", password: "12345678oc" },
        { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
      ];

      // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π ===
      useEffect(() => {
        fetch(`${API_ORIGIN}/api/companies`)
          .then(r => r.json())
          .then(d => setCompanies(d || ["–ë–¢–¢", "–õ–ò"]))
          .catch(() => setCompanies(["–ë–¢–¢", "–õ–ò"]));
      }, []);

      // === –ù–ê–î–Å–ñ–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
      useEffect(() => {
        if (!user) return;
        setLoading(true);
        setInventory([]);
        setShipments([]);
        fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
          .then(r => r.json())
          .then(data => {
            const inv = (data.inventory || []).map((it, i) => ({ ...it, id: it.id || `inv_${Date.now()}_${i}` }));
            const shp = (data.shipments || []).map((it, i) => ({ ...it, id: it.id || `ship_${Date.now()}_${i}` }));
            setInventory(inv);
            setShipments(shp);
            setProducts([...new Set(inv.map(x => x.product).filter(Boolean))]);
            setClients([...new Set(shp.map(x => x.client).filter(Boolean))]);
            setManagers([...new Set(shp.map(x => x.manager).filter(Boolean))]);
          })
          .finally(() => setLoading(false));
      }, [user, company]);

      // === –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===
      useEffect(() => {
        if (!user || userRole !== "admin") return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          }).catch(console.error);
        }, 800);
      }, [inventory, shipments, company]);

      // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
      const handleLogin = (e) => {
        e.preventDefault();
        const admin = admins.find(a => a.username.toLowerCase() === userName.toLowerCase() && a.password === password);
        if (password && !admin) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        setUser(userName);
        setUserRole(admin ? "admin" : "viewer");
      };

      // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / —É–¥–∞–ª–µ–Ω–∏–µ ===
      const handleStockSubmit = (e) => { ... }; // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
      const handleShipmentSubmit = (e) => { ... }; // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å

      const handleDelete = (type, id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
        if (type === "inventory") setInventory(prev => prev.filter(x => x.id !== id));
        if (type === "shipment") setShipments(prev => prev.filter(x => x.id !== id));
      };

      const saveEdit = () => {
        if (!editItem) return;
        if (editType === "inventory") setInventory(prev => prev.map(x => x.id === editItem.id ? editItem : x));
        if (editType === "shipment") setShipments(prev => prev.map(x => x.id === editItem.id ? editItem : x));
        setEditItem(null);
      };

      // === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ===
      const groupedInventory = inventory
        .filter(i => i.company === company && (filterProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || i.product === filterProduct))
        .reduce((acc, i) => {
          if (!acc[i.product]) acc[i.product] = [];
          acc[i.product].push(i);
          return acc;
        }, {});

      // === –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ===
      if (!user) return ( ... —Ç–æ—Ç –∂–µ –±–ª–æ–∫ –≤—Ö–æ–¥–∞ ... );

      return (
        <div class="max-w-6xl mx-auto">
          <div class="flex justify-between mb-4">
            <h1 class="text-xl font-bold">–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ ({company}) ‚Äî {user}</h1>
            <select value={company} onChange={e => setCompany(e.target.value)} class="border p-2 rounded">
              {companies.map(c => <option key={c}>{c}</option>)}
            </select>
          </div>

          <div class="mb-4">
            <button onClick={() => setActiveTab("inventory")} class={`p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}`}>–û—Å—Ç–∞—Ç–∫–∏</button>
            <button onClick={() => setActiveTab("shipments")} class={`p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}`}>–û—Ç–≥—Ä—É–∑–∫–∏</button>
          </div>

          {activeTab === "inventory" && (
            <>
              {/* —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ñ–æ—Ä–º–∞ */}
              {Object.entries(groupedInventory).map(([product, items]) => (
                <div key={product} class="mb-6">
                  <h2 class="text-lg font-semibold mb-2">{product}</h2>
                  <table class="w-full border-collapse bg-white shadow">
                    <thead>
                      <tr class="bg-gray-100">
                        {["–î–∞—Ç–∞", "–õ–æ—Ç", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏", "–î–µ–π—Å—Ç–≤–∏—è"].map(h => (
                          <th key={h} class="border p-2 text-left">{h}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {items.map(it => (
                        <tr key={it.id}>
                          <td class="border p-2">{it.date}</td>
                          <td class="border p-2">{it.lot}</td>
                          <td class="border p-2">{it.quantity}</td>
                          <td class="border p-2">{it.expiryDate}</td>
                          <td class="border p-2">
                            <button onClick={() => { setEditItem({ ...it }); setEditType("inventory"); }} class="text-blue-500 mr-2">‚úèÔ∏è</button>
                            <button onClick={() => handleDelete("inventory", it.id)} class="text-red-500">üóëÔ∏è</button>
                          </td>
                        </tr>
                      ))}
                      <tr class="font-bold bg-gray-50">
                        <td class="border p-2" colSpan="2">–ò—Ç–æ–≥–æ</td>
                        <td class="border p-2">{items.reduce((s, i) => s + Number(i.quantity), 0)}</td>
                        <td class="border p-2" colSpan="2"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              ))}
            </>
          )}

          {activeTab === "shipments" && (
            shipments.filter(s => s.company === company).map(s => (
              <div key={s.id} class="bg-white rounded shadow p-3 mb-2 flex justify-between">
                <div>{s.date} ‚Äî {s.client} ‚Äî {s.product} ({s.lot}) ‚Äî {s.quantity} —à—Ç. ‚Äî {s.manager}</div>
                <div>
                  <button onClick={() => { setEditItem({ ...s }); setEditType("shipment"); }} class="text-blue-500 mr-2">‚úèÔ∏è</button>
                  <button onClick={() => handleDelete("shipment", s.id)} class="text-red-500">üóëÔ∏è</button>
                </div>
              </div>
            ))
          )}

          {editItem && (
            <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40">
              <div class="bg-white p-4 rounded shadow-lg w-96">
                <h2 class="text-lg font-bold mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                {Object.keys(editItem).filter(k => !["id", "company"].includes(k)).map(key => (
                  <div key={key} class="mb-2">
                    <label class="block text-sm font-medium">{key}</label>
                    <input class="border rounded p-1 w-full" value={editItem[key] ?? ""} onChange={e => setEditItem({ ...editItem, [key]: e.target.value })} />
                  </div>
                ))}
                <div class="flex justify-end mt-3">
                  <button onClick={saveEdit} class="bg-blue-500 text-white px-3 py-1 rounded mr-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button onClick={() => setEditItem(null)} class="bg-gray-400 text-white px-3 py-1 rounded">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
