<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Учет продукции на складе</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");
      const [company, setCompany] = useState("БТТ");
      const [companies, setCompanies] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [filterProduct, setFilterProduct] = useState("Все продукты");
      const [activeTab, setActiveTab] = useState("inventory");
      const [loading, setLoading] = useState(false);
      const saveTimeout = useRef(null);

      const admins = [
        { username: "Леонид", password: "12345678lm" },
        { username: "Ольга", password: "12345678oc" },
        { username: "Дмитрий", password: "12345678dd" }
      ];

      const API_ORIGIN = window.location.origin;

      // === Загрузка компаний ===
      useEffect(() => {
        fetch(`${API_ORIGIN}/api/companies`)
          .then(r => r.json())
          .then(data => setCompanies(data || ["БТТ", "ЛИ"]))
          .catch(() => setCompanies(["БТТ", "ЛИ"]));
      }, []);

      // === Загрузка данных ===
      useEffect(() => {
        if (!user) return;
        setLoading(true);
        fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
          .then(r => r.json())
          .then(data => {
            setInventory(data.inventory || []);
            setShipments(data.shipments || []);
            setProducts([...new Set((data.inventory || []).map(i => i.product))].filter(Boolean));
            setClients([...new Set((data.shipments || []).map(i => i.client))].filter(Boolean));
            setManagers([...new Set((data.shipments || []).map(i => i.manager))].filter(Boolean));
          })
          .finally(() => setLoading(false));
      }, [user, company]);

      // === Автосохранение ===
      useEffect(() => {
        if (!user || userRole !== "admin") return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          }).catch(console.error);
        }, 800);
      }, [inventory, shipments]);

      // === Авторизация ===
      const handleLogin = (e) => {
        e.preventDefault();
        const admin = admins.find(a => a.username.toLowerCase() === userName.toLowerCase() && a.password === password);
        if (password && !admin) return alert("Неверный пароль");
        setUser(userName);
        setUserRole(admin ? "admin" : "viewer");
      };

      // === Добавление Остатков ===
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split("T")[0],
        product: "",
        lot: "",
        quantity: "",
        expiryDate: ""
      });
      const handleAddStock = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return alert("Только админ может добавлять записи");
        const existing = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
        if (existing) {
          setInventory(inv => inv.map(i => i === existing ? { ...i, quantity: Number(i.quantity) + Number(newStock.quantity) } : i));
        } else {
          setInventory(inv => [...inv, { ...newStock, id: Date.now(), company, quantity: Number(newStock.quantity) }]);
        }
        if (!products.includes(newStock.product) && newStock.product) setProducts(p => [...p, newStock.product]);
        setNewStock({ ...newStock, product: "", lot: "", quantity: "", expiryDate: "" });
      };

      // === Добавление Отгрузки ===
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split("T")[0],
        client: "",
        product: "",
        lot: "",
        quantity: "",
        manager: ""
      });
      const handleAddShipment = (e) => {
        e.preventDefault();
        if (userRole !== "admin") return alert("Только админ может добавлять записи");
        const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
        if (!stock || stock.quantity < Number(newShipment.quantity)) return alert("Недостаточно остатков!");
        setShipments(s => [...s, { ...newShipment, id: Date.now(), company, quantity: Number(newShipment.quantity) }]);
        setInventory(inv => inv.map(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company
          ? { ...i, quantity: i.quantity - newShipment.quantity } : i));
        if (newShipment.client && !clients.includes(newShipment.client)) setClients(c => [...c, newShipment.client]);
        if (newShipment.manager && !managers.includes(newShipment.manager)) setManagers(m => [...m, newShipment.manager]);
        setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
      };

      // === Экспорт Excel ===
      const exportToExcel = (data, filename, headers) => {
        if (!data.length) return alert("Нет данных для экспорта");
        const ws = XLSX.utils.json_to_sheet(data, { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        saveAs(new Blob([wbout], { type: "application/octet-stream" }), filename);
      };
      const exportInventory = () => {
        const data = inventory.filter(i => i.company === company)
          .map(i => ({ Дата: i.date, Продукция: i.product, "№ Лота": i.lot, Количество: i.quantity, "Срок годности": i.expiryDate }));
        exportToExcel(data, `inventory_${company}.xlsx`, ["Дата", "Продукция", "№ Лота", "Количество", "Срок годности"]);
      };
      const exportShipments = () => {
        const data = shipments.filter(s => s.company === company)
          .map(s => ({ Дата: s.date, Клиент: s.client, Продукция: s.product, "№ Лота": s.lot, Количество: s.quantity, Менеджер: s.manager }));
        exportToExcel(data, `shipments_${company}.xlsx`, ["Дата", "Клиент", "Продукция", "№ Лота", "Количество", "Менеджер"]);
      };

      // === Вспомогательные ===
      const productLots = (prod) => inventory.filter(i => i.product === prod && i.company === company).map(i => i.lot);

      // === Фильтрация и сортировка ===
      const filteredInventory = inventory.filter(i => i.company === company)
        .filter(i => filterProduct === "Все продукты" || i.product === filterProduct)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      const filteredShipments = shipments.filter(s => s.company === company)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      // === Интерфейс ===
      if (!user) {
        return (
          React.createElement("div", { className: "max-w-md mx-auto p-4" },
            React.createElement("h1", { className: "text-2xl font-bold mb-4" }, "Вход в систему"),
            React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
              React.createElement("input", { placeholder: "Имя пользователя", value: userName, onChange: e => setUserName(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "password", placeholder: "Пароль (для админов)", value: password, onChange: e => setPassword(e.target.value), className: "border p-2 rounded" }),
              React.createElement("button", { type: "submit", className: "bg-blue-500 text-white py-2 px-4 rounded" }, "Войти")
            )
          )
        );
      }

      return (
        React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `Учет продукции (${company}) — ${user}`),
            React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 rounded" },
              companies.map((c, i) => React.createElement("option", { key: i, value: c }, c))
            )
          ),

          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "Остатки"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "Отгрузки")
          ),

          // === Остатки ===
          activeTab === "inventory" && React.createElement("div", null,
            React.createElement("div", { className: "flex justify-between mb-2" },
              React.createElement("div", null,
                React.createElement("label", null, "Фильтр: "),
                React.createElement("select", { value: filterProduct, onChange: e => setFilterProduct(e.target.value), className: "border p-2 rounded ml-2" },
                  React.createElement("option", { value: "Все продукты" }, "Все продукты"),
                  products.map((p, i) => React.createElement("option", { key: i, value: p }, p))
                )
              ),
              React.createElement("button", { onClick: exportInventory, className: "bg-green-600 text-white px-4 py-2 rounded" }, "⬇️ Экспорт")
            ),
            React.createElement("form", { onSubmit: handleAddStock, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newStock.date, onChange: e => setNewStock(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "prodList", placeholder: "Продукция", value: newStock.product, onChange: e => setNewStock(s => ({ ...s, product: e.target.value, lot: "" })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "prodList" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { placeholder: "№ Лота", value: newStock.lot, onChange: e => setNewStock(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { type: "number", placeholder: "Количество", value: newStock.quantity, onChange: e => setNewStock(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { type: "date", placeholder: "Срок годности", value: newStock.expiryDate, onChange: e => setNewStock(s => ({ ...s, expiryDate: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white py-2 px-4 rounded" }, "Добавить")
            ),
            React.createElement("table", { className: "w-full border-collapse bg-white shadow" },
              React.createElement("thead", null,
                React.createElement("tr", { className: "bg-gray-100" },
                  ["Дата", "Продукция", "№ Лота", "Количество", "Срок годности"].map((h, i) =>
                    React.createElement("th", { key: i, className: "border p-2 text-left" }, h)
                  )
                )
              ),
              React.createElement("tbody", null,
                filteredInventory.map(i =>
                  React.createElement("tr", { key: i.id },
                    React.createElement("td", { className: "border p-2" }, i.date),
                    React.createElement("td", { className: "border p-2" }, i.product),
                    React.createElement("td", { className: "border p-2" }, i.lot),
                    React.createElement("td", { className: "border p-2" }, i.quantity),
                    React.createElement("td", { className: "border p-2" }, i.expiryDate || "")
                  )
                )
              )
            )
          ),

          // === Отгрузки ===
          activeTab === "shipments" && React.createElement("div", null,
            React.createElement("div", { className: "flex justify-end mb-2" },
              React.createElement("button", { onClick: exportShipments, className: "bg-green-600 text-white px-4 py-2 rounded" }, "⬇️ Экспорт")
            ),
            React.createElement("form", { onSubmit: handleAddShipment, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newShipment.date, onChange: e => setNewShipment(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "clientList", placeholder: "Клиент", value: newShipment.client, onChange: e => setNewShipment(s => ({ ...s, client: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "clientList" }, clients.map((c, i) => React.createElement("option", { key: i, value: c }))),
              React.createElement("input", { list: "prodShipList", placeholder: "Продукция", value: newShipment.product, onChange: e => setNewShipment(s => ({ ...s, product: e.target.value, lot: "" })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "prodShipList" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { list: "lotShipList", placeholder: "№ Лота", value: newShipment.lot, onChange: e => setNewShipment(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "lotShipList" }, productLots(newShipment.product).map((l, i) => React.createElement("option", { key: i, value: l }))),
              React.createElement("input", { type: "number", placeholder: "Количество", value: newShipment.quantity, onChange: e => setNewShipment(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "managerList", placeholder: "Менеджер", value: newShipment.manager, onChange: e => setNewShipment(s => ({ ...s, manager: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "managerList" }, managers.map((m, i) => React.createElement("option", { key: i, value: m }))),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white py-2 px-4 rounded" }, "Добавить")
            ),
            React.createElement("table", { className: "w-full border-collapse bg-white shadow" },
              React.createElement("thead", null,
                React.createElement("tr", { className: "bg-gray-100" },
                  ["Дата", "Клиент", "Продукция", "№ Лота", "Количество", "Менеджер"].map((h, i) =>
                    React.createElement("th", { key: i, className: "border p-2 text-left" }, h)
                  )
                )
              ),
              React.createElement("tbody", null,
                filteredShipments.map(s =>
                  React.createElement("tr", { key: s.id },
                    React.createElement("td", { className: "border p-2" }, s.date),
                    React.createElement("td", { className: "border p-2" }, s.client),
                    React.createElement("td", { className: "border p-2" }, s.product),
                    React.createElement("td", { className: "border p-2" }, s.lot),
                    React.createElement("td", { className: "border p-2" }, s.quantity),
                    React.createElement("td", { className: "border p-2" }, s.manager)
                  )
                )
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
