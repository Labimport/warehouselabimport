<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учет продукции на складе</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <div id="error" class="text-red-500 p-4"></div>
  <script>
    const { useState, useEffect } = React;

    const App = () => {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState('');
      const [password, setPassword] = useState('');
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        client: '',
        quantity: '',
        manager: '',
        company: 'БТТ'
      });
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        quantity: '',
        expiryDate: '',
        company: 'БТТ'
      });
      const [activeTab, setActiveTab] = useState('inventory');
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [error, setError] = useState('');
      const [filterProduct, setFilterProduct] = useState('Все продукты');
      const [filterClient, setFilterClient] = useState('Все клиенты');
      const [filterManager, setFilterManager] = useState('Все менеджеры');
      const [editItem, setEditItem] = useState(null);
      const [company, setCompany] = useState('БТТ');
      const [companies, setCompanies] = useState([]);
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [loading, setLoading] = useState(false); // ✅ добавлен флаг загрузки

      const admins = [
        { username: 'Леонид', password: '12345678lm' },
        { username: 'Ольга', password: '12345678oc' },
        { username: 'Дмитрий', password: '12345678dd' }
      ];

      useEffect(() => {
        fetch('/api/companies')
          .then(response => response.json())
          .then(data => {
            console.log('Компании:', data);
            setCompanies(data || ['БТТ', 'ЛИ']);
          })
          .catch(error => setError('Ошибка загрузки компаний: ' + error.message));
      }, []);

      useEffect(() => {
        const loadData = (username, company) => {
          setLoading(true); // ✅ начинаем загрузку
          fetch(`/api/data/${username}/${company}`)
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log('Данные загружены для компании:', company, data);
              const filteredInventory = (data.inventory || []).map((item, index) => ({
                ...item,
                company: item.company || company,
                id: item.id || `inv_${Date.now()}_${index}`
              })).filter(item => item.company === company);
              const filteredShipments = (data.shipments || []).map((item, index) => ({
                ...item,
                company: item.company || company,
                id: item.id || `ship_${Date.now()}_${index}`
              })).filter(item => item.company === company);
              setInventory(filteredInventory);
              setShipments(filteredShipments);
              const allProducts = [...new Set([...filteredInventory.map(i => i.product), ...filteredShipments.map(s => s.product)])];
              const allClients = [...new Set(filteredShipments.map(s => s.client))];
              const allManagers = [...new Set(filteredShipments.map(s => s.manager))];
              setProducts(allProducts.filter(p => p));
              setClients(allClients.filter(c => c));
              setManagers(allManagers.filter(m => m));
            })
            .catch(error => setError('Ошибка загрузки данных: ' + error.message))
            .finally(() => setLoading(false)); // ✅ завершаем загрузку
        };

        if (user) {
          loadData(user, company);
          console.log('Пользователь авторизован:', user, 'Компания:', company);
        } else {
          loadData('Леонид', company);
          console.log('Гостевой доступ для:', 'Леонид', 'Компания:', company);
        }
      }, [user, company]);

      // ✅ сохраняем данные только если не идет загрузка
      useEffect(() => {
        if (!loading && user && userRole === 'admin') {
          saveData(user, company, { inventory, shipments });
        }
      }, [inventory, shipments, user, loading]);

      const saveData = (username, company, data) => {
        fetch(`/api/data/${username}/${company}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (!response.ok) throw new Error('Ошибка сохранения данных');
          return response.json();
        })
        .catch(error => setError('Ошибка сохранения данных: ' + error.message));
      };

      const handleLogin = (e) => {
        e.preventDefault();
        if (!userName.trim()) {
          setError('Введите имя пользователя');
          return;
        }
        const trimmedUserName = userName.trim();
        console.log('Попытка логина:', { username: trimmedUserName, password });
        const isAdmin = admins.find(
          admin => admin.username.toLowerCase() === trimmedUserName.toLowerCase() && admin.password === password
        );
        if (password && !isAdmin) {
          setError('Неверный пароль для администратора');
          return;
        }
        setUser(trimmedUserName);
        setUserRole(isAdmin ? 'admin' : 'viewer');
        setPassword('');
        console.log('Логин успешен:', { user: trimmedUserName, role: userRole });
      };

      // (всё остальное — без изменений)
      // ...
      // твои функции handleStockSubmit, handleShipmentSubmit, экспорт и рендеринг остаются прежними
    };

    try {
      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    } catch (e) {
      document.getElementById('error').innerText = 'Ошибка рендеринга: ' + e.message;
    }
  </script>
</body>
</html>
