<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState("");
      const [password, setPassword] = useState("");

      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [activeTab, setActiveTab] = useState("inventory");
      const [company, setCompany] = useState("–ë–¢–¢");
      const [companies, setCompanies] = useState([]);
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);
      const [editItem, setEditItem] = useState(null); // –¥–ª—è popup
      const [editType, setEditType] = useState(null); // inventory / shipment
      const saveTimeout = useRef(null);

      const admins = [
        { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
        { username: "–û–ª—å–≥–∞", password: "12345678oc" },
        { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
      ];

      const API = window.location.origin;

      // –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π
      useEffect(() => {
        fetch(`${API}/api/companies`)
          .then(r => r.json())
          .then(d => setCompanies(d || ["–ë–¢–¢", "–õ–ò"]))
          .catch(e => console.error(e));
      }, []);

      // –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      useEffect(() => {
        if (!user) return;
        setLoading(true);
        fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
          .then(r => r.json())
          .then(data => {
            setInventory(data.inventory || []);
            setShipments(data.shipments || []);
          })
          .finally(() => setLoading(false));
      }, [user, company]);

      // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      useEffect(() => {
        if (!user || userRole !== "admin" || loading) return;
        if (saveTimeout.current) clearTimeout(saveTimeout.current);
        saveTimeout.current = setTimeout(() => {
          fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory, shipments })
          });
        }, 1000);
        return () => clearTimeout(saveTimeout.current);
      }, [inventory, shipments, company]);

      const handleLogin = (e) => {
        e.preventDefault();
        const admin = admins.find(a => a.username.toLowerCase() === userName.toLowerCase() && a.password === password);
        if (password && !admin) return setError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        setUser(userName);
        setUserRole(admin ? "admin" : "viewer");
      };

      // —É–¥–∞–ª–µ–Ω–∏–µ
      const deleteRecord = (type, id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
        fetch(`/api/${type}/${id}`, { method: "DELETE" })
          .then(() => {
            if (type === "inventory") setInventory(prev => prev.filter(x => x.id !== id));
            if (type === "shipment") setShipments(prev => prev.filter(x => x.id !== id));
          });
      };

      // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (popup)
      const saveEdit = () => {
        if (!editItem) return;
        const type = editType;
        fetch(`/api/${type}/${editItem.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(editItem)
        }).then(() => {
          if (type === "inventory")
            setInventory(prev => prev.map(x => x.id === editItem.id ? editItem : x));
          if (type === "shipment")
            setShipments(prev => prev.map(x => x.id === editItem.id ? editItem : x));
          setEditItem(null);
        });
      };

      if (!user)
        return (
          React.createElement("div", { className: "max-w-md mx-auto p-4" },
            React.createElement("h1", { className: "text-2xl font-bold mb-4" }, "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É"),
            React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
              React.createElement("input", { placeholder: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", value: userName, onChange: e => setUserName(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "password", placeholder: "–ü–∞—Ä–æ–ª—å", value: password, onChange: e => setPassword(e.target.value), className: "border p-2 rounded" }),
              React.createElement("button", { type: "submit", className: "bg-blue-500 text-white py-2 px-4 rounded" }, "–í–æ–π—Ç–∏")
            )
          )
        );

      return (
        React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (${company}) ‚Äî ${user}`),
            React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 rounded" },
              companies.map((c, i) => React.createElement("option", { key: i, value: c }, c))
            )
          ),

          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Å—Ç–∞—Ç–∫–∏"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Ç–≥—Ä—É–∑–∫–∏")
          ),

          // === –û—Å—Ç–∞—Ç–∫–∏ ===
          activeTab === "inventory" && React.createElement("div", null,
            inventory.filter(i => i.company === company).map(i =>
              React.createElement("div", { key: i.id, className: "bg-white rounded shadow p-3 mb-2 flex justify-between items-center" },
                React.createElement("div", null, `${i.date} ‚Äî ${i.product} (${i.lot}) ‚Äî ${i.quantity} —à—Ç.`),
                React.createElement("div", null,
                  React.createElement("button", { onClick: () => { setEditItem({ ...i }); setEditType("inventory"); }, className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                  React.createElement("button", { onClick: () => deleteRecord("inventory", i.id), className: "text-red-500" }, "üóëÔ∏è")
                )
              )
            )
          ),

          // === –û—Ç–≥—Ä—É–∑–∫–∏ ===
          activeTab === "shipments" && React.createElement("div", null,
            shipments.filter(s => s.company === company).map(s =>
              React.createElement("div", { key: s.id, className: "bg-white rounded shadow p-3 mb-2 flex justify-between items-center" },
                React.createElement("div", null, `${s.date} ‚Äî ${s.client} ‚Äî ${s.product} (${s.lot}) ‚Äî ${s.quantity} —à—Ç. ‚Äî ${s.manager}`),
                React.createElement("div", null,
                  React.createElement("button", { onClick: () => { setEditItem({ ...s }); setEditType("shipment"); }, className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                  React.createElement("button", { onClick: () => deleteRecord("shipment", s.id), className: "text-red-500" }, "üóëÔ∏è")
                )
              )
            )
          ),

          // === Popup ===
          editItem && React.createElement("div", { className: "fixed inset-0 flex items-center justify-center bg-black bg-opacity-40" },
            React.createElement("div", { className: "bg-white p-4 rounded shadow-lg w-96" },
              React.createElement("h2", { className: "text-lg font-bold mb-2" }, "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏"),
              Object.keys(editItem).filter(k => !["id"].includes(k)).map((key, idx) =>
                React.createElement("div", { key: idx, className: "mb-2" },
                  React.createElement("label", { className: "block text-sm font-medium" }, key),
                  React.createElement("input", {
                    className: "border rounded p-1 w-full",
                    value: editItem[key] ?? "",
                    onChange: e => setEditItem({ ...editItem, [key]: e.target.value })
                  })
                )
              ),
              React.createElement("div", { className: "flex justify-end mt-4" },
                React.createElement("button", { onClick: saveEdit, className: "bg-blue-500 text-white px-3 py-1 rounded mr-2" }, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"),
                React.createElement("button", { onClick: () => setEditItem(null), className: "bg-gray-400 text-white px-3 py-1 rounded" }, "–û—Ç–º–µ–Ω–∞")
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
