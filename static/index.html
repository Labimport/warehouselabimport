<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-50">
  <div id="root" class="p-4"></div>

  <script>
    (function () {
      const { useState, useEffect, useRef } = React;

      function App() {
        // --- auth / basic state
        const [user, setUser] = useState(localStorage.getItem("wl_user") || null);
        const [userRole, setUserRole] = useState(localStorage.getItem("wl_role") || null);
        const [loginName, setLoginName] = useState("");
        const [loginPass, setLoginPass] = useState("");

        const [companies, setCompanies] = useState([]);
        const [company, setCompany] = useState(localStorage.getItem("wl_company") || "–ë–¢–¢");

        const [inventory, setInventory] = useState([]);
        const [shipments, setShipments] = useState([]);

        const [products, setProducts] = useState([]);
        const [clients, setClients] = useState([]);
        const [managers, setManagers] = useState([]);

        // new item forms
        const [newStock, setNewStock] = useState({
          date: new Date().toISOString().split("T")[0],
          product: "",
          lot: "",
          quantity: "",
          expiryDate: ""
        });
        const [newShipment, setNewShipment] = useState({
          date: new Date().toISOString().split("T")[0],
          client: "",
          product: "",
          lot: "",
          quantity: "",
          manager: ""
        });

        const [activeTab, setActiveTab] = useState("inventory");

        // shipments filters
        const [filterFrom, setFilterFrom] = useState("");
        const [filterTo, setFilterTo] = useState("");
        const [filterShipProduct, setFilterShipProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
        const [filterClient, setFilterClient] = useState("–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã");
        const [filterManager, setFilterManager] = useState("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã");

        // inventory product filter
        const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");

        // editing state
        const [editingInventoryId, setEditingInventoryId] = useState(null);
        const [editingInventoryData, setEditingInventoryData] = useState(null);
        const [editingShipmentId, setEditingShipmentId] = useState(null);
        const [editingShipmentData, setEditingShipmentData] = useState(null);

        const [loading, setLoading] = useState(false);
        const saveTimeout = useRef(null);
        const API_ORIGIN = window.location.origin;

        const admins = [
          { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
          { username: "–û–ª—å–≥–∞", password: "12345678oc" },
          { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
        ];

        // helper: immediate save for a specific user+company pair
        async function saveCompanyData(forUser, forCompany, newInv, newShp) {
          try {
            await fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(forUser)}/${encodeURIComponent(forCompany)}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ inventory: newInv, shipments: newShp })
            });
            return true;
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ saveCompanyData:", e);
            return false;
          }
        }

        // helper: load company data (returns {inventory, shipments})
        async function loadCompanyData(forUser, forCompany) {
          try {
            const r = await fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(forUser)}/${encodeURIComponent(forCompany)}`);
            if (!r.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å");
            return await r.json();
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ loadCompanyData:", e);
            return { inventory: [], shipments: [] };
          }
        }

        // load companies list
        useEffect(() => {
          fetch(`${API_ORIGIN}/api/companies`)
            .then(r => r.json())
            .then(d => {
              if (Array.isArray(d) && d.length) setCompanies(d);
              else setCompanies(["–ë–¢–¢", "–õ–ò"]);
            })
            .catch(() => setCompanies(["–ë–¢–¢", "–õ–ò"]));
        }, []);

        // load data when user & company set
        useEffect(() => {
          if (!user) return;
          setLoading(true);
          setInventory([]);
          setShipments([]);
          fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
            .then(r => r.json())
            .then(data => {
              const inv = (data.inventory || []).map((it, i) => ({ ...it, id: it.id || `inv_${Date.now()}_${i}` }));
              const shp = (data.shipments || []).map((it, i) => ({ ...it, id: it.id || `ship_${Date.now()}_${i}` }));
              setInventory(inv);
              setShipments(shp);
              setProducts([...new Set(inv.map(x => x.product).filter(Boolean))]);
              setClients([...new Set(shp.map(x => x.client).filter(Boolean))]);
              setManagers([...new Set(shp.map(x => x.manager).filter(Boolean))]);
            })
            .catch(err => {
              console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
              setInventory([]);
              setShipments([]);
            })
            .finally(() => setLoading(false));
        }, [user, company]);

        // autosave for current company (admin only)
        useEffect(() => {
          if (!user || userRole !== "admin") return;
          if (saveTimeout.current) clearTimeout(saveTimeout.current);
          saveTimeout.current = setTimeout(() => {
            fetch(`${API_ORIGIN}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ inventory, shipments })
            }).catch(e => console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e));
          }, 800);
          return () => clearTimeout(saveTimeout.current);
        }, [inventory, shipments, user, userRole, company]);

        // persist selected company locally
        useEffect(() => {
          localStorage.setItem("wl_company", company);
        }, [company]);

        // login / logout
        const handleLogin = (e) => {
          e && e.preventDefault();
          const admin = admins.find(a => a.username.toLowerCase() === loginName.toLowerCase() && a.password === loginPass);
          if (loginPass && !admin) {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
            return;
          }
          const role = admin ? "admin" : "viewer";
          setUser(loginName);
          setUserRole(role);
          localStorage.setItem("wl_user", loginName);
          localStorage.setItem("wl_role", role);
        };
        const logout = () => {
          localStorage.removeItem("wl_user");
          localStorage.removeItem("wl_role");
          setUser(null);
          setUserRole(null);
        };

        // helper: lots for a product (for datalist)
        const productLots = (prod) => inventory.filter(i => i.product === prod && i.company === company).map(i => i.lot);

        // EXPORT helpers
        const exportInventory = () => {
          const data = inventory.filter(i => i.company === company).map(i => ({ –î–∞—Ç–∞: i.date, –ü—Ä–æ–¥—É–∫—Ü–∏—è: i.product, –õ–æ—Ç: i.lot, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: i.quantity, "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏": i.expiryDate }));
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "–û—Å—Ç–∞—Ç–∫–∏");
          const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          saveAs(new Blob([wbout], { type: "application/octet-stream" }), `–û—Å—Ç–∞—Ç–∫–∏_${company}.xlsx`);
        };
        const exportShipments = () => {
          const data = shipments.filter(s => s.company === company).map(s => ({ –î–∞—Ç–∞: s.date, –ö–ª–∏–µ–Ω—Ç: s.client, –ü—Ä–æ–¥—É–∫—Ü–∏—è: s.product, –õ–æ—Ç: s.lot, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: s.quantity, –ú–µ–Ω–µ–¥–∂–µ—Ä: s.manager }));
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "–û—Ç–≥—Ä—É–∑–∫–∏");
          const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          saveAs(new Blob([wbout], { type: "application/octet-stream" }), `–û—Ç–≥—Ä—É–∑–∫–∏_${company}.xlsx`);
        };

        // grouped inventory (for display)
        const groupedInventory = inventory
          .filter(i => i.company === company && (filterProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || i.product === filterProduct))
          .reduce((acc, it) => {
            if (!acc[it.product]) acc[it.product] = [];
            acc[it.product].push(it);
            return acc;
          }, {});

        // --------------- MIRROR LOGIC (–∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏—è–º–∏) ---------------
        // convention:
        // - when creating mirrored inventory in otherCompany we add metadata fields:
        //    _mirror_from = { company: originalCompany, shipmentId: <id> }
        // so we can find and update/delete mirror entries later.
        //
        // We'll perform mirror updates by fetching other company's data and posting it back.
        async function createMirrorForShipment(shipment) {
          // find other company (if shipment.client equals an existing company and NOT equal current company)
          const other = companies.find(c => c === shipment.client && c !== company);
          if (!other || !user) return;
          // load other company's data
          const otherData = await loadCompanyData(user, other);
          const otherInv = otherData.inventory || [];
          // create incoming inventory entry on other company
          const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
          const newItem = {
            id,
            company: other,
            date: shipment.date,
            product: shipment.product,
            lot: shipment.lot,
            quantity: Number(shipment.quantity),
            expiryDate: shipment.expiryDate || "",
            // marker for mirror: from which company and which shipment
            _mirror_from: { company: company, shipmentId: shipment.id }
          };
          otherInv.push(newItem);
          // save other company's data back
          await saveCompanyData(user, other, otherInv, otherData.shipments || []);
          return id;
        }

        async function updateMirrorForShipment(oldShipment, newShipment) {
          // determine old target and new target companies
          const oldTarget = companies.find(c => c === (oldShipment && oldShipment.client) && c !== company);
          const newTarget = companies.find(c => c === (newShipment && newShipment.client) && c !== company);

          // if same target (and exists), update mirror entry (match by _mirror_from.shipmentId)
          if (oldTarget && newTarget && oldTarget === newTarget) {
            const otherData = await loadCompanyData(user, newTarget);
            const otherInv = otherData.inventory || [];
            const idx = otherInv.findIndex(i => i._mirror_from && i._mirror_from.company === company && i._mirror_from.shipmentId === newShipment.id);
            if (idx >= 0) {
              otherInv[idx] = {
                ...otherInv[idx],
                date: newShipment.date,
                product: newShipment.product,
                lot: newShipment.lot,
                quantity: Number(newShipment.quantity),
                expiryDate: newShipment.expiryDate || ""
              };
              await saveCompanyData(user, newTarget, otherInv, otherData.shipments || []);
            } else {
              // mirror missing -> create it
              await createMirrorForShipment(newShipment);
            }
            return;
          }

          // if oldTarget != newTarget: remove old mirror (if any) and create new mirror (if needed)
          if (oldTarget && oldTarget !== newTarget) {
            const otherDataOld = await loadCompanyData(user, oldTarget);
            const otherInvOld = otherDataOld.inventory || [];
            const filtered = otherInvOld.filter(i => !(i._mirror_from && i._mirror_from.company === company && i._mirror_from.shipmentId === oldShipment.id));
            await saveCompanyData(user, oldTarget, filtered, otherDataOld.shipments || []);
          }
          if (newTarget) {
            await createMirrorForShipment(newShipment);
          }
        }

        async function removeMirrorForShipment(shipment) {
          const target = companies.find(c => c === shipment.client && c !== company);
          if (!target) return;
          const otherData = await loadCompanyData(user, target);
          const otherInv = otherData.inventory || [];
          const filtered = otherInv.filter(i => !(i._mirror_from && i._mirror_from.company === company && i._mirror_from.shipmentId === shipment.id));
          await saveCompanyData(user, target, filtered, otherData.shipments || []);
        }

        // ------------------ CRUD actions (local + mirror + save) -------------------
        // add stock
        const handleStockSubmit = (e) => {
          e && e.preventDefault();
          if (userRole !== "admin") return;
          if (!newStock.product || !newStock.lot || !newStock.quantity) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –ø—Ä–æ–¥—É–∫—Ü–∏—è, –ª–æ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
            return;
          }
          const existing = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
          if (existing) {
            const newInv = inventory.map(i => i.id === existing.id ? { ...i, quantity: Number(i.quantity) + Number(newStock.quantity) } : i);
            setInventory(newInv);
            // immediate save
            saveCompanyData(user, company, newInv, shipments);
          } else {
            const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
            const newItem = { ...newStock, id, company, quantity: Number(newStock.quantity) };
            const newInv = [...inventory, newItem];
            setInventory(newInv);
            saveCompanyData(user, company, newInv, shipments);
          }
          setProducts(prev => (newStock.product ? Array.from(new Set([...prev, newStock.product])) : prev));
          setNewStock({ ...newStock, product: "", lot: "", quantity: "", expiryDate: "" });
        };

        // add shipment (and mirror if client==other company)
        const handleShipmentSubmit = async (e) => {
          e && e.preventDefault();
          if (userRole !== "admin") return;
          if (!newShipment.product || !newShipment.lot || !newShipment.quantity) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –ø—Ä–æ–¥—É–∫—Ü–∏—è, –ª–æ—Ç –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
            return;
          }
          const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
          if (!stock || stock.quantity < Number(newShipment.quantity)) {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ!");
            return;
          }

          const id = `ship_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
          const newShip = { ...newShipment, id, company, quantity: Number(newShipment.quantity) };
          const newShips = [...shipments, newShip];
          const newInv = inventory.map(i => (i.product === newShipment.product && i.lot === newShipment.lot && i.company === company) ? { ...i, quantity: i.quantity - Number(newShipment.quantity) } : i);

          // update local state and immediate save current company
          setShipments(newShips);
          setInventory(newInv);
          await saveCompanyData(user, company, newInv, newShips);

          // update lists for datalists
          setClients(prev => (newShipment.client ? Array.from(new Set([...prev, newShipment.client])) : prev));
          setManagers(prev => (newShipment.manager ? Array.from(new Set([...prev, newShipment.manager])) : prev));
          setProducts(prev => (newShipment.product ? Array.from(new Set([...prev, newShipment.product])) : prev));

          // create mirror if needed
          const other = companies.find(c => c === newShipment.client && c !== company);
          if (other) {
            // create mirrored inventory in other company
            await createMirrorForShipment(newShip);
          }

          setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
        };

        // delete inventory (immediate)
        const deleteInventory = async (id) => {
          if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫?")) return;
          const newInv = inventory.filter(i => i.id !== id);
          setInventory(newInv);
          await saveCompanyData(user, company, newInv, shipments);
        };

        // delete shipment (and remove mirror if exists)
        const deleteShipment = async (id) => {
          if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É?")) return;
          const ship = shipments.find(s => s.id === id);
          const newShips = shipments.filter(s => s.id !== id);
          // when deleting a shipment we should restore stock in this company if shipment originally deducted it?
          // In this app existing behavior earlier simply removed shipment; to keep consistent we will
          // add the quantity back to inventory if there's matching product+lot in this company, else add a new inventory row with that quantity (as "–≤–æ–∑–≤—Ä–∞—Ç").
          if (ship) {
            const same = inventory.find(i => i.product === ship.product && i.lot === ship.lot && i.company === company);
            let newInv;
            if (same) {
              newInv = inventory.map(i => i.id === same.id ? { ...i, quantity: Number(i.quantity) + Number(ship.quantity) } : i);
            } else {
              const idInv = `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
              const newItem = { id: idInv, company, date: ship.date, product: ship.product, lot: ship.lot, quantity: Number(ship.quantity), expiryDate: ship.expiryDate || "" };
              newInv = [...inventory, newItem];
            }
            setInventory(newInv);
            setShipments(newShips);
            await saveCompanyData(user, company, newInv, newShips);

            // remove mirror on the other company if exists
            await removeMirrorForShipment(ship);
          } else {
            // fallback: just remove and save
            setShipments(newShips);
            await saveCompanyData(user, company, inventory, newShips);
          }
        };

        // editing inventory
        const startEditInventory = (row) => {
          setEditingInventoryId(row.id);
          setEditingInventoryData({ ...row, quantity: String(row.quantity) });
        };
        const cancelEditInventory = () => {
          setEditingInventoryId(null);
          setEditingInventoryData(null);
        };
        const saveEditInventory = async () => {
          if (!editingInventoryData) return;
          const newInv = inventory.map(i => i.id === editingInventoryData.id ? ({ ...editingInventoryData, quantity: Number(editingInventoryData.quantity) }) : i);
          setInventory(newInv);
          setProducts(prev => (editingInventoryData.product ? Array.from(new Set([...prev, editingInventoryData.product])) : prev));
          setEditingInventoryId(null);
          setEditingInventoryData(null);
          await saveCompanyData(user, company, newInv, shipments);
        };

        // editing shipment
        const startEditShipment = (row) => {
          setEditingShipmentId(row.id);
          setEditingShipmentData({ ...row, quantity: String(row.quantity) });
        };
        const cancelEditShipment = () => {
          setEditingShipmentId(null);
          setEditingShipmentData(null);
        };
        const saveEditShipment = async () => {
          if (!editingShipmentData) return;
          const orig = shipments.find(s => s.id === editingShipmentData.id);
          // Adjust local inventory in current company if quantity or product/lot changed:
          // We'll compute delta: if quantity changed, restore/deduct difference.
          const newShips = shipments.map(s => s.id === editingShipmentData.id ? ({ ...editingShipmentData, quantity: Number(editingShipmentData.quantity) }) : s);

          // compute inventory adjustments on this company:
          let invCopy = [...inventory];
          if (orig) {
            // if product/lot changed OR quantity changed, reverse original deduction, then apply new deduction
            // reverse original: add back original quantity to matching inv (or create new)
            const origMatch = invCopy.find(i => i.product === orig.product && i.lot === orig.lot && i.company === company);
            if (origMatch) {
              invCopy = invCopy.map(i => i.id === origMatch.id ? ({ ...i, quantity: Number(i.quantity) + Number(orig.quantity) }) : i);
            } else {
              // create
              invCopy.push({ id: `inv_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, company, date: orig.date, product: orig.product, lot: orig.lot, quantity: Number(orig.quantity), expiryDate: orig.expiryDate || "" });
            }

            // now apply new deduction
            const newMatch = invCopy.find(i => i.product === editingShipmentData.product && i.lot === editingShipmentData.lot && i.company === company);
            if (newMatch) {
              // ensure not going negative (if would go negative, alert and abort)
              const newQty = Number(newMatch.quantity) - Number(editingShipmentData.quantity);
              if (newQty < 0) {
                alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
                // need to reload original state to avoid partial changes
                // reload data from server for safety:
                const server = await loadCompanyData(user, company);
                setInventory(server.inventory || []);
                setShipments(server.shipments || []);
                return;
              }
              invCopy = invCopy.map(i => i.id === newMatch.id ? ({ ...i, quantity: newQty }) : i);
            } else {
              // no matching lot/product left to deduct from (can't create negative)
              alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ª–æ—Ç–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.");
              const server = await loadCompanyData(user, company);
              setInventory(server.inventory || []);
              setShipments(server.shipments || []);
              return;
            }
          }

          // update local state and save current company
          setInventory(invCopy);
          setShipments(newShips);
          await saveCompanyData(user, company, invCopy, newShips);

          // handle mirror update across companies
          await updateMirrorForShipment(orig, { ...editingShipmentData, quantity: Number(editingShipmentData.quantity) });

          // update lists
          setClients(prev => editingShipmentData.client ? Array.from(new Set([...prev, editingShipmentData.client])) : prev);
          setManagers(prev => editingShipmentData.manager ? Array.from(new Set([...prev, editingShipmentData.manager])) : prev);
          setProducts(prev => editingShipmentData.product ? Array.from(new Set([...prev, editingShipmentData.product])) : prev);

          setEditingShipmentId(null);
          setEditingShipmentData(null);
        };

        // filtered shipments for UI
        const filteredShipments = shipments
          .filter(s => s.company === company)
          .filter(s => !filterFrom || s.date >= filterFrom)
          .filter(s => !filterTo || s.date <= filterTo)
          .filter(s => filterShipProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || s.product === filterShipProduct)
          .filter(s => filterClient === "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" || s.client === filterClient)
          .filter(s => filterManager === "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" || s.manager === filterManager);

        // UI
        if (!user) {
          return React.createElement("div", { className: "max-w-md mx-auto p-4" },
            React.createElement("h1", { className: "text-2xl font-bold mb-4" }, "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É"),
            React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
              React.createElement("input", { placeholder: "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", value: loginName, onChange: e => setLoginName(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "password", placeholder: "–ü–∞—Ä–æ–ª—å (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)", value: loginPass, onChange: e => setLoginPass(e.target.value), className: "border p-2 rounded" }),
              React.createElement("div", { className: "flex gap-2" },
                React.createElement("button", { type: "submit", className: "bg-blue-500 text-white py-2 px-4 rounded" }, "–í–æ–π—Ç–∏"),
                React.createElement("button", { type: "button", onClick: () => { setLoginName("–õ–µ–æ–Ω–∏–¥"); setLoginPass("12345678lm"); }, className: "bg-gray-200 px-3 rounded" }, "–í–≤–µ—Å—Ç–∏ demo")
              )
            )
          );
        }

        return React.createElement("div", { className: "max-w-6xl mx-auto" },
          // header
          React.createElement("div", { className: "flex justify-between mb-4 items-center" },
            React.createElement("h1", { className: "text-xl font-bold" }, `–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (${company}) ‚Äî ${user}`),
            React.createElement("div", { className: "flex items-center gap-2" },
              React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 rounded" },
                companies.map(c => React.createElement("option", { key: c }, c))
              ),
              React.createElement("button", { onClick: logout, className: "bg-red-500 text-white px-3 py-2 rounded" }, "–í—ã–π—Ç–∏")
            )
          ),

          // tabs
          React.createElement("div", { className: "mb-4" },
            React.createElement("button", { onClick: () => setActiveTab("inventory"), className: `p-2 mr-2 ${activeTab === "inventory" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Å—Ç–∞—Ç–∫–∏"),
            React.createElement("button", { onClick: () => setActiveTab("shipments"), className: `p-2 ${activeTab === "shipments" ? "bg-blue-500 text-white" : "bg-gray-200"}` }, "–û—Ç–≥—Ä—É–∑–∫–∏")
          ),

          // INVENTORY tab
          activeTab === "inventory" && React.createElement("div", null,
            // filter + export
            React.createElement("div", { className: "flex items-center gap-3 mb-4" },
              React.createElement("label", null, "–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏:"),
              React.createElement("select", { value: filterProduct, onChange: e => setFilterProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))
              ),
              React.createElement("button", { onClick: exportInventory, className: "bg-green-600 text-white px-4 py-2 rounded ml-auto" }, "‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç")
            ),

            // add stock form (with datalist for product + lot)
            userRole === "admin" && React.createElement("form", { onSubmit: handleStockSubmit, className: "flex flex-wrap gap-2 mb-6" },
              React.createElement("input", { type: "date", value: newStock.date, onChange: e => setNewStock(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "productList", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è", value: newStock.product, onChange: e => setNewStock(s => ({ ...s, product: e.target.value, lot: "" })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "productList" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { placeholder: "‚Ññ –õ–æ—Ç–∞", list: "lotListAdd", value: newStock.lot, onChange: e => setNewStock(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "lotListAdd" }, inventory.filter(i => i.company === company && (!newStock.product || i.product === newStock.product)).map((l, i) => React.createElement("option", { key: i, value: l.lot }))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", value: newStock.quantity, onChange: e => setNewStock(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { type: "date", placeholder: "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏", value: newStock.expiryDate, onChange: e => setNewStock(s => ({ ...s, expiryDate: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white py-2 px-4 rounded" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),

            // grouped inventory tables (with edit/delete)
            Object.entries(groupedInventory).length === 0
              ? React.createElement("div", { className: "text-gray-500" }, loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "–ù–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤")
              : Object.entries(groupedInventory).map(([prod, items]) =>
                React.createElement("div", { key: prod, className: "mb-6" },
                  React.createElement("h2", { className: "text-lg font-semibold mb-2" }, prod),
                  React.createElement("table", { className: "w-full border-collapse bg-white shadow" },
                    React.createElement("thead", null,
                      React.createElement("tr", { className: "bg-gray-100" },
                        ["–î–∞—Ç–∞", "–õ–æ—Ç", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏", "–î–µ–π—Å—Ç–≤–∏—è"].map(h => React.createElement("th", { key: h, className: "border p-2 text-left" }, h))
                      )
                    ),
                    React.createElement("tbody", null,
                      items.map(it =>
                        editingInventoryId === it.id
                          ? React.createElement("tr", { key: it.id },
                              React.createElement("td", { className: "border p-2" }, React.createElement("input", { type: "date", value: editingInventoryData.date || "", onChange: e => setEditingInventoryData(d => ({ ...d, date: e.target.value })), className: "border p-1 rounded w-full" })),
                              React.createElement("td", { className: "border p-2" }, React.createElement("input", { value: editingInventoryData.lot || "", onChange: e => setEditingInventoryData(d => ({ ...d, lot: e.target.value })), className: "border p-1 rounded w-full" })),
                              React.createElement("td", { className: "border p-2" }, React.createElement("input", { type: "number", value: editingInventoryData.quantity || "", onChange: e => setEditingInventoryData(d => ({ ...d, quantity: e.target.value })), className: "border p-1 rounded w-full" })),
                              React.createElement("td", { className: "border p-2" }, React.createElement("input", { type: "date", value: editingInventoryData.expiryDate || "", onChange: e => setEditingInventoryData(d => ({ ...d, expiryDate: e.target.value })), className: "border p-1 rounded w-full" })),
                              React.createElement("td", { className: "border p-2" },
                                React.createElement("button", { onClick: saveEditInventory, className: "bg-green-500 text-white px-2 py-1 rounded mr-2" }, "üíæ"),
                                React.createElement("button", { onClick: cancelEditInventory, className: "bg-gray-400 text-white px-2 py-1 rounded" }, "‚úñ")
                              )
                            )
                          : React.createElement("tr", { key: it.id },
                              React.createElement("td", { className: "border p-2" }, it.date),
                              React.createElement("td", { className: "border p-2" }, it.lot),
                              React.createElement("td", { className: "border p-2" }, it.quantity),
                              React.createElement("td", { className: "border p-2" }, it.expiryDate),
                              React.createElement("td", { className: "border p-2" },
                                userRole === "admin" ? React.createElement("span", null,
                                  React.createElement("button", { onClick: () => startEditInventory(it), className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                                  React.createElement("button", { onClick: () => deleteInventory(it.id), className: "text-red-500" }, "üóëÔ∏è")
                                ) : React.createElement("span", null, "-")
                              )
                            )
                      ),
                      // sum row per product
                      React.createElement("tr", { className: "font-bold bg-gray-50" },
                        React.createElement("td", { className: "border p-2", colSpan: 2 }, "–ò—Ç–æ–≥–æ –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏"),
                        React.createElement("td", { className: "border p-2" }, items.reduce((s, x) => s + Number(x.quantity || 0), 0)),
                        React.createElement("td", { className: "border p-2", colSpan: 2 })
                      )
                    )
                  )
                )
              )
          ),

          // SHIPMENTS tab
          activeTab === "shipments" && React.createElement("div", null,
            // filters row
            React.createElement("div", { className: "flex flex-wrap gap-3 mb-4 items-end" },
              React.createElement("div", null, React.createElement("label", null, "–û—Ç –¥–∞—Ç—ã:"), React.createElement("input", { type: "date", value: filterFrom, onChange: e => setFilterFrom(e.target.value), className: "border p-2 rounded" })),
              React.createElement("div", null, React.createElement("label", null, "–î–æ –¥–∞—Ç—ã:"), React.createElement("input", { type: "date", value: filterTo, onChange: e => setFilterTo(e.target.value), className: "border p-2 rounded" })),
              React.createElement("div", null, React.createElement("label", null, "–ü—Ä–æ–¥—É–∫—Ü–∏—è:"), React.createElement("select", { value: filterShipProduct, onChange: e => setFilterShipProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))
              )),
              React.createElement("div", null, React.createElement("label", null, "–ö–ª–∏–µ–Ω—Ç:"), React.createElement("select", { value: filterClient, onChange: e => setFilterClient(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" }, "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"),
                clients.map(c => React.createElement("option", { key: c, value: c }, c))
              )),
              React.createElement("div", null, React.createElement("label", null, "–ú–µ–Ω–µ–¥–∂–µ—Ä:"), React.createElement("select", { value: filterManager, onChange: e => setFilterManager(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" }, "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã"),
                managers.map(m => React.createElement("option", { key: m, value: m }, m))
              )),
              React.createElement("button", { onClick: exportShipments, className: "bg-green-600 text-white px-4 py-2 rounded ml-auto" }, "‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç")
            ),

            // add shipment form (with datalists)
            userRole === "admin" && React.createElement("form", { onSubmit: handleShipmentSubmit, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newShipment.date, onChange: e => setNewShipment(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "clientList", placeholder: "–ö–ª–∏–µ–Ω—Ç (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥—É—é –∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è)", value: newShipment.client, onChange: e => setNewShipment(s => ({ ...s, client: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "clientList" }, clients.map((c, i) => React.createElement("option", { key: i, value: c }))),
              React.createElement("input", { list: "productShipList", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è", value: newShipment.product, onChange: e => setNewShipment(s => ({ ...s, product: e.target.value, lot: "" })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "productShipList" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { placeholder: "–õ–æ—Ç", list: "lotList", value: newShipment.lot, onChange: e => setNewShipment(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "lotList" }, inventory.filter(i => i.product === newShipment.product && i.company === company).map((l, i) => React.createElement("option", { key: i, value: l.lot }))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", value: newShipment.quantity, onChange: e => setNewShipment(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "managerList", placeholder: "–ú–µ–Ω–µ–¥–∂–µ—Ä", value: newShipment.manager, onChange: e => setNewShipment(s => ({ ...s, manager: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "managerList" }, managers.map((m, i) => React.createElement("option", { key: i, value: m }))),
              React.createElement("button", { type: "submit", className: "bg-green-500 text-white px-4 py-2 rounded" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),

            // list of shipments (filtered) with inline edit/delete
            filteredShipments.length === 0
              ? React.createElement("div", { className: "text-gray-500" }, "–ù–µ—Ç –æ—Ç–≥—Ä—É–∑–æ–∫")
              : filteredShipments.map(s =>
                editingShipmentId === s.id
                  ? React.createElement("div", { key: s.id, className: "bg-white rounded shadow p-3 mb-2" },
                      React.createElement("div", { className: "flex flex-wrap gap-2 items-center" },
                        React.createElement("input", { type: "date", value: editingShipmentData.date || "", onChange: e => setEditingShipmentData(d => ({ ...d, date: e.target.value })), className: "border p-2 rounded" }),
                        React.createElement("input", { value: editingShipmentData.client || "", onChange: e => setEditingShipmentData(d => ({ ...d, client: e.target.value })), list: "clientList", className: "border p-2 rounded", placeholder: "–ö–ª–∏–µ–Ω—Ç" }),
                        React.createElement("input", { value: editingShipmentData.product || "", onChange: e => setEditingShipmentData(d => ({ ...d, product: e.target.value })), list: "productShipList", className: "border p-2 rounded", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è" }),
                        React.createElement("input", { value: editingShipmentData.lot || "", onChange: e => setEditingShipmentData(d => ({ ...d, lot: e.target.value })), className: "border p-2 rounded", placeholder: "–õ–æ—Ç" }),
                        React.createElement("input", { type: "number", value: editingShipmentData.quantity || "", onChange: e => setEditingShipmentData(d => ({ ...d, quantity: e.target.value })), className: "border p-2 rounded", placeholder: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" }),
                        React.createElement("input", { value: editingShipmentData.manager || "", onChange: e => setEditingShipmentData(d => ({ ...d, manager: e.target.value })), className: "border p-2 rounded", placeholder: "–ú–µ–Ω–µ–¥–∂–µ—Ä" }),
                        React.createElement("div", { className: "ml-auto" },
                          React.createElement("button", { onClick: saveEditShipment, className: "bg-green-500 text-white px-3 py-1 rounded mr-2" }, "üíæ"),
                          React.createElement("button", { onClick: cancelEditShipment, className: "bg-gray-400 text-white px-3 py-1 rounded" }, "‚úñ")
                        )
                      )
                    )
                  : React.createElement("div", { key: s.id, className: "bg-white rounded shadow p-3 mb-2 flex justify-between" },
                      React.createElement("div", null, `${s.date} ‚Äî ${s.client} ‚Äî ${s.product} (${s.lot})`),
                      React.createElement("div", null, `${s.quantity} —à—Ç. ‚Äî ${s.manager}`,
                        userRole === "admin" && React.createElement("span", null,
                          React.createElement("button", { onClick: () => startEditShipment(s), className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                          React.createElement("button", { onClick: () => deleteShipment(s.id), className: "text-red-500" }, "üóëÔ∏è")
                        )
                      )
                    )
              ),

            // export shipments button
            React.createElement("div", { className: "mt-3" },
              React.createElement("button", { onClick: exportShipments, className: "bg-green-600 text-white px-4 py-2 rounded" }, "‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç")
            )
          )
        );
      } // end App

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    })();
  </script>
</body>
</html>
