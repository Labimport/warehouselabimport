<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4"></div>

  <script>
    (function () {
      const { useState, useEffect, useRef } = React;

      function App() {
        const [user, setUser] = useState(localStorage.getItem("wl_user") || null);
        const [userRole, setUserRole] = useState(localStorage.getItem("wl_role") || null);
        const [loginName, setLoginName] = useState("");
        const [loginPass, setLoginPass] = useState("");

        const [companies, setCompanies] = useState([]);
        const [company, setCompany] = useState(localStorage.getItem("wl_company") || "–ë–¢–¢");

        const [inventory, setInventory] = useState([]);
        const [shipments, setShipments] = useState([]);

        const [products, setProducts] = useState([]);
        const [clients, setClients] = useState([]);
        const [managers, setManagers] = useState([]);

        const [newStock, setNewStock] = useState({
          date: new Date().toISOString().split("T")[0],
          product: "",
          lot: "",
          quantity: "",
          expiryDate: ""
        });
        const [newShipment, setNewShipment] = useState({
          date: new Date().toISOString().split("T")[0],
          client: "",
          product: "",
          lot: "",
          quantity: "",
          manager: ""
        });

        const [activeTab, setActiveTab] = useState("inventory");
        const [filterFrom, setFilterFrom] = useState("");
        const [filterTo, setFilterTo] = useState("");
        const [filterShipProduct, setFilterShipProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");
        const [filterClient, setFilterClient] = useState("–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã");
        const [filterManager, setFilterManager] = useState("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã");
        const [filterProduct, setFilterProduct] = useState("–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã");

        const [editingInventoryId, setEditingInventoryId] = useState(null);
        const [editingInventoryData, setEditingInventoryData] = useState(null);
        const [editingShipmentId, setEditingShipmentId] = useState(null);
        const [editingShipmentData, setEditingShipmentData] = useState(null);

        const API = window.location.origin;
        const saveTimeout = useRef(null);

        const admins = [
          { username: "–õ–µ–æ–Ω–∏–¥", password: "12345678lm" },
          { username: "–û–ª—å–≥–∞", password: "12345678oc" },
          { username: "–î–º–∏—Ç—Ä–∏–π", password: "12345678dd" }
        ];

        // ===== helper
        const saveNow = async (inv = inventory, shp = shipments) => {
          if (!user) return;
          await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inventory: inv, shipments: shp })
          }).catch(console.error);
        };

        const saveToOtherCompany = async (targetCompany, invItem) => {
          try {
            const res = await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(targetCompany)}`);
            const data = await res.json();
            const targetInv = data.inventory || [];
            const existing = targetInv.find(i => i.product === invItem.product && i.lot === invItem.lot);
            if (existing) existing.quantity = Number(existing.quantity) + Number(invItem.quantity);
            else targetInv.push({ ...invItem, id: `inv_${Date.now()}`, company: targetCompany });
            await fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(targetCompany)}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ inventory: targetInv, shipments: data.shipments || [] })
            });
          } catch (err) { console.error("saveToOtherCompany:", err); }
        };

        // ===== init
        useEffect(() => {
          fetch(`${API}/api/companies`)
            .then(r => r.json())
            .then(d => setCompanies(d.length ? d : ["–ë–¢–¢", "–õ–ò"]))
            .catch(() => setCompanies(["–ë–¢–¢", "–õ–ò"]));
        }, []);

        useEffect(() => {
          if (!user) return;
          fetch(`${API}/api/data/${encodeURIComponent(user)}/${encodeURIComponent(company)}`)
            .then(r => r.json())
            .then(data => {
              const inv = (data.inventory || []).map((i, idx) => ({ ...i, id: i.id || `inv_${idx}` }));
              const shp = (data.shipments || []).map((i, idx) => ({ ...i, id: i.id || `ship_${idx}` }));
              setInventory(inv);
              setShipments(shp);
              setProducts([...new Set(inv.map(i => i.product).filter(Boolean))]);
              setClients([...new Set(shp.map(i => i.client).filter(Boolean))]);
              setManagers([...new Set(shp.map(i => i.manager).filter(Boolean))]);
            });
        }, [user, company]);

        useEffect(() => localStorage.setItem("wl_company", company), [company]);

        // ===== login/logout
        const handleLogin = (e) => {
          e.preventDefault();
          const admin = admins.find(a => a.username.toLowerCase() === loginName.toLowerCase() && a.password === loginPass);
          const role = admin ? "admin" : "viewer";
          if (loginPass && !admin) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
          setUser(loginName);
          setUserRole(role);
          localStorage.setItem("wl_user", loginName);
          localStorage.setItem("wl_role", role);
        };
        const logout = () => { localStorage.clear(); setUser(null); setUserRole(null); };

        // ===== stock add
        const handleStockSubmit = (e) => {
          e.preventDefault();
          if (!newStock.product || !newStock.lot || !newStock.quantity) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
          const existing = inventory.find(i => i.product === newStock.product && i.lot === newStock.lot && i.company === company);
          const newInv = existing
            ? inventory.map(i => i.id === existing.id ? { ...i, quantity: Number(i.quantity) + Number(newStock.quantity) } : i)
            : [...inventory, { ...newStock, id: `inv_${Date.now()}`, company, quantity: Number(newStock.quantity) }];
          setInventory(newInv);
          setProducts(prev => [...new Set([...prev, newStock.product])]);
          saveNow(newInv, shipments);
          setNewStock({ ...newStock, product: "", lot: "", quantity: "", expiryDate: "" });
        };

        // ===== shipment add (+mirror)
        const handleShipmentSubmit = async (e) => {
          e.preventDefault();
          if (!newShipment.product || !newShipment.lot || !newShipment.quantity) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
          const stock = inventory.find(i => i.product === newShipment.product && i.lot === newShipment.lot && i.company === company);
          if (!stock || stock.quantity < Number(newShipment.quantity)) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞—Ç–∫–æ–≤");
          const newShip = { ...newShipment, id: `ship_${Date.now()}`, company, quantity: Number(newShipment.quantity) };
          const newShips = [...shipments, newShip];
          const newInv = inventory.map(i => (i.product === newShipment.product && i.lot === newShipment.lot && i.company === company)
            ? { ...i, quantity: i.quantity - Number(newShipment.quantity) } : i);
          setShipments(newShips); setInventory(newInv);
          setClients(p => [...new Set([...p, newShipment.client])]);
          setManagers(p => [...new Set([...p, newShipment.manager])]);
          setProducts(p => [...new Set([...p, newShipment.product])]);
          saveNow(newInv, newShips);
          const other = company === "–ë–¢–¢" ? "–õ–ò" : "–ë–¢–¢";
          if (newShipment.client === other)
            await saveToOtherCompany(other, { ...newShipment, quantity: Number(newShipment.quantity) });
          setNewShipment({ ...newShipment, client: "", product: "", lot: "", quantity: "", manager: "" });
        };

        // ===== editing inventory
        const saveEditInventory = () => {
          if (!editingInventoryData) return;
          const updated = inventory.map(i => i.id === editingInventoryData.id
            ? { ...editingInventoryData, quantity: Number(editingInventoryData.quantity) } : i);
          setInventory(updated);
          setProducts([...new Set(updated.map(i => i.product))]);
          saveNow(updated, shipments);
          setEditingInventoryId(null); setEditingInventoryData(null);
        };

        // ===== editing shipment
        const saveEditShipment = () => {
          if (!editingShipmentData) return;
          const updated = shipments.map(s => s.id === editingShipmentData.id
            ? { ...editingShipmentData, quantity: Number(editingShipmentData.quantity) } : s);
          setShipments(updated);
          setClients([...new Set(updated.map(s => s.client))]);
          setManagers([...new Set(updated.map(s => s.manager))]);
          setProducts([...new Set([...products, editingShipmentData.product])]);
          saveNow(inventory, updated);
          setEditingShipmentId(null); setEditingShipmentData(null);
        };

        const deleteInventory = (id) => { if (!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
          const newInv = inventory.filter(i => i.id !== id); setInventory(newInv); saveNow(newInv, shipments); };
        const deleteShipment = (id) => { if (!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
          const newShips = shipments.filter(s => s.id !== id); setShipments(newShips); saveNow(inventory, newShips); };

        const groupedInventory = inventory.filter(i => i.company === company && (filterProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || i.product === filterProduct))
          .reduce((a, i) => { (a[i.product] ||= []).push(i); return a; }, {});

        const filteredShipments = shipments.filter(s => s.company === company)
          .filter(s => !filterFrom || s.date >= filterFrom)
          .filter(s => !filterTo || s.date <= filterTo)
          .filter(s => filterShipProduct === "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" || s.product === filterShipProduct)
          .filter(s => filterClient === "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" || s.client === filterClient)
          .filter(s => filterManager === "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" || s.manager === filterManager);

        const lots = (prod) => inventory.filter(i => i.product === prod && i.company === company).map(i => i.lot);

        if (!user) return (
          React.createElement("div", { className: "max-w-md mx-auto p-4" },
            React.createElement("h1", { className: "text-2xl font-bold mb-4" }, "–í—Ö–æ–¥"),
            React.createElement("form", { onSubmit: handleLogin, className: "flex flex-col gap-2" },
              React.createElement("input", { placeholder: "–ò–º—è", value: loginName, onChange: e => setLoginName(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "password", placeholder: "–ü–∞—Ä–æ–ª—å", value: loginPass, onChange: e => setLoginPass(e.target.value), className: "border p-2 rounded" }),
              React.createElement("button", { className: "bg-blue-500 text-white py-2 rounded" }, "–í–æ–π—Ç–∏")
            )
          )
        );

        return React.createElement("div", { className: "max-w-6xl mx-auto" },
          React.createElement("div", { className: "flex justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-bold" }, `–°–∫–ª–∞–¥ (${company}) ‚Äî ${user}`),
            React.createElement("div", null,
              React.createElement("select", { value: company, onChange: e => setCompany(e.target.value), className: "border p-2 mr-2" },
                companies.map(c => React.createElement("option", { key: c }, c))),
              React.createElement("button", { onClick: logout, className: "bg-red-500 text-white px-3 py-1 rounded" }, "–í—ã–π—Ç–∏")
            )
          ),
          React.createElement("div", { className: "mb-4" },
            ["inventory", "shipments"].map(t =>
              React.createElement("button", { key: t, onClick: () => setActiveTab(t),
                className: `p-2 mr-2 ${activeTab === t ? "bg-blue-500 text-white" : "bg-gray-200"}` },
                t === "inventory" ? "–û—Å—Ç–∞—Ç–∫–∏" : "–û—Ç–≥—Ä—É–∑–∫–∏"))
          ),

          activeTab === "inventory" && React.createElement("div", null,
            React.createElement("div", { className: "flex items-center gap-3 mb-4" },
              React.createElement("label", null, "–§–∏–ª—å—Ç—Ä:"),
              React.createElement("select", { value: filterProduct, onChange: e => setFilterProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p }, p)))
            ),
            userRole === "admin" && React.createElement("form", { onSubmit: handleStockSubmit, className: "flex flex-wrap gap-2 mb-6" },
              React.createElement("input", { type: "date", value: newStock.date, onChange: e => setNewStock(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "prodList", placeholder: "–ü—Ä–æ–¥—É–∫—Ü–∏—è", value: newStock.product, onChange: e => setNewStock(s => ({ ...s, product: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "prodList" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { list: "lotList", placeholder: "–õ–æ—Ç", value: newStock.lot, onChange: e => setNewStock(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "lotList" }, lots(newStock.product).map((l, i) => React.createElement("option", { key: i, value: l }))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª-–≤–æ", value: newStock.quantity, onChange: e => setNewStock(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("button", { className: "bg-green-500 text-white px-4 py-2 rounded" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),
            Object.entries(groupedInventory).map(([p, items]) =>
              React.createElement("div", { key: p },
                React.createElement("h2", { className: "font-bold" }, p),
                React.createElement("table", { className: "w-full bg-white shadow mb-4" },
                  React.createElement("thead", null,
                    React.createElement("tr", { className: "bg-gray-100" },
                      ["–î–∞—Ç–∞", "–õ–æ—Ç", "–ö–æ–ª-–≤–æ", "–î–µ–π—Å—Ç–≤–∏—è"].map(h => React.createElement("th", { key: h, className: "border p-2 text-left" }, h)))),
                  React.createElement("tbody", null,
                    items.map(it => editingInventoryId === it.id
                      ? React.createElement("tr", { key: it.id },
                          React.createElement("td", { className: "border p-1" }, React.createElement("input", { type: "date", value: editingInventoryData.date, onChange: e => setEditingInventoryData(d => ({ ...d, date: e.target.value })), className: "border p-1 rounded w-full" })),
                          React.createElement("td", { className: "border p-1" }, React.createElement("input", { value: editingInventoryData.lot, onChange: e => setEditingInventoryData(d => ({ ...d, lot: e.target.value })), className: "border p-1 rounded w-full" })),
                          React.createElement("td", { className: "border p-1" }, React.createElement("input", { type: "number", value: editingInventoryData.quantity, onChange: e => setEditingInventoryData(d => ({ ...d, quantity: e.target.value })), className: "border p-1 rounded w-full" })),
                          React.createElement("td", { className: "border p-1" },
                            React.createElement("button", { onClick: saveEditInventory, className: "bg-green-500 text-white px-2 py-1 rounded mr-2" }, "üíæ"),
                            React.createElement("button", { onClick: () => { setEditingInventoryId(null); setEditingInventoryData(null); }, className: "bg-gray-400 text-white px-2 py-1 rounded" }, "‚úñ")))

                      : React.createElement("tr", { key: it.id },
                          React.createElement("td", { className: "border p-2" }, it.date),
                          React.createElement("td", { className: "border p-2" }, it.lot),
                          React.createElement("td", { className: "border p-2" }, it.quantity),
                          React.createElement("td", { className: "border p-2" },
                            userRole === "admin" && React.createElement("span", null,
                              React.createElement("button", { onClick: () => { setEditingInventoryId(it.id); setEditingInventoryData(it); }, className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                              React.createElement("button", { onClick: () => deleteInventory(it.id), className: "text-red-500" }, "üóëÔ∏è")))))))))
          ),

          activeTab === "shipments" && React.createElement("div", null,
            React.createElement("div", { className: "flex gap-2 mb-3 flex-wrap" },
              React.createElement("input", { type: "date", value: filterFrom, onChange: e => setFilterFrom(e.target.value), className: "border p-2 rounded" }),
              React.createElement("input", { type: "date", value: filterTo, onChange: e => setFilterTo(e.target.value), className: "border p-2 rounded" }),
              React.createElement("select", { value: filterShipProduct, onChange: e => setFilterShipProduct(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }, "–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã"),
                products.map(p => React.createElement("option", { key: p, value: p }, p))),
              React.createElement("select", { value: filterClient, onChange: e => setFilterClient(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã" }, "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"),
                clients.map(c => React.createElement("option", { key: c, value: c }, c))),
              React.createElement("select", { value: filterManager, onChange: e => setFilterManager(e.target.value), className: "border p-2 rounded" },
                React.createElement("option", { value: "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã" }, "–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã"),
                managers.map(m => React.createElement("option", { key: m, value: m }, m)))
            ),
            userRole === "admin" && React.createElement("form", { onSubmit: handleShipmentSubmit, className: "flex flex-wrap gap-2 mb-4" },
              React.createElement("input", { type: "date", value: newShipment.date, onChange: e => setNewShipment(s => ({ ...s, date: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "clients", placeholder: "–ö–ª–∏–µ–Ω—Ç", value: newShipment.client, onChange: e => setNewShipment(s => ({ ...s, client: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "clients" }, clients.map((c, i) => React.createElement("option", { key: i, value: c }))),
              React.createElement("input", { list: "prodShip", placeholder: "–ü—Ä–æ–¥—É–∫—Ç", value: newShipment.product, onChange: e => setNewShipment(s => ({ ...s, product: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "prodShip" }, products.map((p, i) => React.createElement("option", { key: i, value: p }))),
              React.createElement("input", { list: "lotShip", placeholder: "–õ–æ—Ç", value: newShipment.lot, onChange: e => setNewShipment(s => ({ ...s, lot: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "lotShip" }, lots(newShipment.product).map((l, i) => React.createElement("option", { key: i, value: l }))),
              React.createElement("input", { type: "number", placeholder: "–ö–æ–ª-–≤–æ", value: newShipment.quantity, onChange: e => setNewShipment(s => ({ ...s, quantity: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("input", { list: "mgrList", placeholder: "–ú–µ–Ω–µ–¥–∂–µ—Ä", value: newShipment.manager, onChange: e => setNewShipment(s => ({ ...s, manager: e.target.value })), className: "border p-2 rounded" }),
              React.createElement("datalist", { id: "mgrList" }, managers.map((m, i) => React.createElement("option", { key: i, value: m }))),
              React.createElement("button", { className: "bg-green-500 text-white px-4 py-2 rounded" }, "–î–æ–±–∞–≤–∏—Ç—å")
            ),
            filteredShipments.map(s => editingShipmentId === s.id
              ? React.createElement("div", { key: s.id, className: "bg-white p-3 mb-2 rounded shadow" },
                  React.createElement("input", { type: "date", value: editingShipmentData.date, onChange: e => setEditingShipmentData(d => ({ ...d, date: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("input", { value: editingShipmentData.client, onChange: e => setEditingShipmentData(d => ({ ...d, client: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("input", { value: editingShipmentData.product, onChange: e => setEditingShipmentData(d => ({ ...d, product: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("input", { value: editingShipmentData.lot, onChange: e => setEditingShipmentData(d => ({ ...d, lot: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("input", { type: "number", value: editingShipmentData.quantity, onChange: e => setEditingShipmentData(d => ({ ...d, quantity: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("input", { value: editingShipmentData.manager, onChange: e => setEditingShipmentData(d => ({ ...d, manager: e.target.value })), className: "border p-2 rounded mr-2" }),
                  React.createElement("button", { onClick: saveEditShipment, className: "bg-green-500 text-white px-2 py-1 rounded mr-2" }, "üíæ"),
                  React.createElement("button", { onClick: () => { setEditingShipmentId(null); setEditingShipmentData(null); }, className: "bg-gray-400 text-white px-2 py-1 rounded" }, "‚úñ"))
              : React.createElement("div", { key: s.id, className: "bg-white p-3 mb-2 flex justify-between shadow rounded" },
                  React.createElement("div", null, `${s.date} ‚Äî ${s.client} ‚Äî ${s.product} (${s.lot}) ‚Äî ${s.quantity} —à—Ç. ‚Äî ${s.manager}`),
                  userRole === "admin" && React.createElement("div", null,
                    React.createElement("button", { onClick: () => { setEditingShipmentId(s.id); setEditingShipmentData(s); }, className: "text-blue-500 mr-2" }, "‚úèÔ∏è"),
                    React.createElement("button", { onClick: () => deleteShipment(s.id), className: "text-red-500" }, "üóëÔ∏è"))))
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    })();
  </script>
</body>
</html>
