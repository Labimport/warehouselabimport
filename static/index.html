<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Учет продукции на складе</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body>
  <div id="root"></div>
  <div id="error" class="text-red-500 p-4"></div>

  <script>
    const { useState, useEffect } = React;

    const App = () => {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [userName, setUserName] = useState('');
      const [password, setPassword] = useState('');
      const [inventory, setInventory] = useState([]);
      const [shipments, setShipments] = useState([]);
      const [newShipment, setNewShipment] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        client: '',
        quantity: '',
        manager: '',
        company: 'БТТ'
      });
      const [newStock, setNewStock] = useState({
        date: new Date().toISOString().split('T')[0],
        product: '',
        lot: '',
        quantity: '',
        expiryDate: '',
        company: 'БТТ'
      });
      const [activeTab, setActiveTab] = useState('inventory');
      const [products, setProducts] = useState([]);
      const [clients, setClients] = useState([]);
      const [managers, setManagers] = useState([]);
      const [error, setError] = useState('');
      const [filterProduct, setFilterProduct] = useState('Все продукты');
      const [filterClient, setFilterClient] = useState('Все клиенты');
      const [filterManager, setFilterManager] = useState('Все менеджеры');
      const [editItem, setEditItem] = useState(null);
      const [company, setCompany] = useState('БТТ');
      const [companies, setCompanies] = useState([]);
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [loading, setLoading] = useState(false); // ✅ защита от автосохранения при загрузке

      const admins = [
        { username: 'Леонид', password: '12345678lm' },
        { username: 'Ольга', password: '12345678oc' },
        { username: 'Дмитрий', password: '12345678dd' }
      ];

      // Загрузка списка компаний
      useEffect(() => {
        fetch(`${window.location.origin}/api/companies`)
          .then(response => response.json())
          .then(data => {
            console.log('Компании:', data);
            setCompanies(data || ['БТТ', 'ЛИ']);
          })
          .catch(error => setError('Ошибка загрузки компаний: ' + error.message));
      }, []);

      // Загрузка данных по пользователю и компании
      useEffect(() => {
        const loadData = (username, company) => {
          setLoading(true);
          fetch(`${window.location.origin}/api/data/${username}/${company}`)
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log('Данные загружены для компании:', company, data);
              const filteredInventory = (data.inventory || []).map((item, index) => ({
                ...item,
                company: item.company || company,
                id: item.id || `inv_${Date.now()}_${index}`
              }));
              const filteredShipments = (data.shipments || []).map((item, index) => ({
                ...item,
                company: item.company || company,
                id: item.id || `ship_${Date.now()}_${index}`
              }));
              setInventory(filteredInventory);
              setShipments(filteredShipments);
              const allProducts = [...new Set([...filteredInventory.map(i => i.product), ...filteredShipments.map(s => s.product)])];
              const allClients = [...new Set(filteredShipments.map(s => s.client))];
              const allManagers = [...new Set(filteredShipments.map(s => s.manager))];
              setProducts(allProducts.filter(Boolean));
              setClients(allClients.filter(Boolean));
              setManagers(allManagers.filter(Boolean));
            })
            .catch(error => setError('Ошибка загрузки данных: ' + error.message))
            .finally(() => setLoading(false));
        };

        if (user) loadData(user, company);
        else loadData('Леонид', company);
      }, [user, company]);

      // Сохранение данных (только если не загружаем)
      useEffect(() => {
        if (!loading && user && userRole === 'admin') {
          fetch(`${window.location.origin}/api/data/${user}/${company}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inventory, shipments })
          }).catch(err => setError('Ошибка сохранения: ' + err.message));
        }
      }, [inventory, shipments, user, loading]);

      const handleLogin = (e) => {
        e.preventDefault();
        const trimmedUserName = userName.trim();
        if (!trimmedUserName) {
          setError('Введите имя пользователя');
          return;
        }
        const isAdmin = admins.find(
          admin => admin.username.toLowerCase() === trimmedUserName.toLowerCase() && admin.password === password
        );
        if (password && !isAdmin) {
          setError('Неверный пароль для администратора');
          return;
        }
        setUser(trimmedUserName);
        setUserRole(isAdmin ? 'admin' : 'viewer');
        setPassword('');
      };

      if (!user) {
        return React.createElement(
          'div', { className: 'container mx-auto p-4' },
          React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, 'Вход в систему'),
          React.createElement(
            'form',
            { onSubmit: handleLogin, className: 'flex space-x-2' },
            React.createElement('input', { type: 'text', placeholder: 'Имя пользователя', value: userName, onChange: e => setUserName(e.target.value), className: 'border p-2 rounded' }),
            React.createElement('input', { type: 'password', placeholder: 'Пароль (для админов)', value: password, onChange: e => setPassword(e.target.value), className: 'border p-2 rounded' }),
            React.createElement('button', { type: 'submit', className: 'bg-blue-500 text-white p-2 rounded' }, 'Войти')
          ),
          error && React.createElement('div', { className: 'text-red-500 mt-2' }, error)
        );
      }

      return React.createElement(
        'div', { className: 'container mx-auto p-4' },
        React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, `Учет продукции (${company}) — ${user}`),
        React.createElement('select', { value: company, onChange: e => setCompany(e.target.value), className: 'border p-2 rounded mb-4' },
          companies.map((c, i) => React.createElement('option', { key: i, value: c }, c))
        ),
        loading && React.createElement('div', { className: 'text-blue-500 mb-2' }, 'Загрузка данных...'),
        error && React.createElement('div', { className: 'text-red-500 mb-2' }, error),
        React.createElement('pre', null, JSON.stringify({ inventory, shipments }, null, 2))
      );
    };

    try {
      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    } catch (e) {
      document.getElementById('error').innerText = 'Ошибка рендеринга: ' + e.message;
    }
  </script>
</body>
</html>
